<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚òÉÔ∏è –ó–∏–º–æ–≤–∏–π –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –ó–∞–≤–¥–∞–Ω—å ‚òÉÔ∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #001f3f;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .task-list-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .message-bubble:hover .delete-msg-btn {
            opacity: 1;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .report-table th, .report-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            vertical-align: top;
            text-align: left;
            word-wrap: break-word;
        }
        .report-table th {
            background-color: #f9fafb;
        }
        .report-table td:first-child {
            font-weight: 600;
        }
        .report-task-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .report-task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        #snowfall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(4px 4px at 20% 30%, #fff, transparent),
                radial-gradient(6px 6px at 40% 60%, #fff, transparent),
                radial-gradient(3px 3px at 50% 80%, #fff, transparent),
                radial-gradient(4px 4px at 70% 50%, #fff, transparent),
                radial-gradient(6px 6px at 90% 20%, #fff, transparent),
                radial-gradient(3px 3px at 10% 70%, #fff, transparent);
            background-size: 500px 500px;
            animation: snowfall 10s linear infinite;
            z-index: 40;
            pointer-events: none;
        }

        @keyframes snowfall {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 500px 500px;
            }
        }
        
        .btn-frosty {
            background: linear-gradient(145deg, #ffffff, #e6f7ff) !important;
            border: 1px solid #cceeff !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1), 
                        inset 0 0 10px rgba(255, 255, 255, 0.7) !important;
            color: #003366 !important;
            text-shadow: 1px 1px 2px #fff;
            transition: all 0.3s ease;
        }

        .btn-frosty:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 100, 200, 0.2), 
                        inset 0 0 10px rgba(255, 255, 255, 1) !important;
        }
        
        .garland {
            position: fixed;
            top: 5px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 45;
            pointer-events: none;
        }
        .garland-light {
            display: inline-block;
            width: 12px;
            height: 20px;
            border-radius: 50%;
            margin: 0 8px;
            animation: blink 1.2s infinite;
        }

        .garland-light.red { background-color: #f00; box-shadow: 0 0 7px 3px #f00; animation-delay: 0s; }
        .garland-light.green { background-color: #0f0; box-shadow: 0 0 7px 3px #0f0; animation-delay: 0.2s; }
        .garland-light.blue { background-color: #00f; box-shadow: 0 0 7px 3px #00f; animation-delay: 0.4s; }
        .garland-light.yellow { background-color: #ff0; box-shadow: 0 0 7px 3px #ff0; animation-delay: 0.6s; }
        .garland-light.purple { background-color: #800080; box-shadow: 0 0 7px 3px #800080; animation-delay: 0.8s; }

        @keyframes blink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.9); }
        }
        
        /* Shelf Styles */
        .shelf-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid #bfdbfe;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .shelf-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
            border-color: #60a5fa;
        }
        .resource-item {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .resource-item:hover {
            background-color: #f0f9ff;
            border-color: #bae6fd;
            transform: translateX(2px);
        }
        .resource-favicon {
            width: 20px;
            height: 20px;
            object-fit: contain;
            border-radius: 4px;
            background-color: white;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }
        
        /* Sticker Styles */
        .sticker {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .sticker:hover {
            transform: scale(1.02) rotate(-1deg);
            box-shadow: 4px 4px 10px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .board-task-card {
            background: white;
            border-radius: 0.75rem;
            border-left: 4px solid #6366f1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .timeline-item { display: flex; gap: 12px; padding: 12px; border-radius: 10px; transition: transform .12s; }
        .timeline-item:hover { transform: translateY(-4px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
        .timeline-avatar { flex: 0 0 44px; height:44px; width:44px; border-radius:9999px; display:flex; align-items:center; justify-content:center; font-weight:600; color:white; }
        .timeline-card { flex:1; min-width:0; }
        .timeline-meta { font-size:12px; color:#6b7280; margin-top:6px; }
        .timeline-badge { display:inline-flex; align-items:center; gap:8px; background:#f8fafc; padding:6px 8px; border-radius:8px; font-weight:600; font-size:13px; }
        @media (min-width: 768px) {
            #board-report-body { display:block; }
            /* left-line for desktop */
            #board-report-body::before {
            content: '';
            position: absolute;
            left: calc(50% - 1px);
            top: 120px;
            bottom: 72px;
            width: 2px;
            background: linear-gradient(#e6eefb, #f3f4f6);
            opacity: 0.8;
            transform: translateX(-50%);
            }
        }
        @media (max-width: 767px) {
            #board-report-body { padding: 12px; }
            .timeline-item { flex-direction: row; }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <!-- –ì–Ü–†–õ–Ø–ù–î–ò -->
    <div class="garland">
        <div class="garland-light red"></div>
        <div class="garland-light green"></div>
        <div class="garland-light blue"></div>
        <div class="garland-light yellow"></div>
        <div class="garland-light purple"></div>
        <div class="garland-light red"></div>
        <div class="garland-light green"></div>
        <div class="garland-light blue"></div>
        <div class="garland-light yellow"></div>
        <div class="garland-light purple"></div>
        <div class="garland-light red"></div>
        <div class="garland-light green"></div>
        <div class="garland-light blue"></div>
        <div class="garland-light yellow"></div>
        <div class="garland-light purple"></div>
        <div class="garland-light red"></div>
        <div class="garland-light green"></div>
        <div class="garland-light blue"></div>
        <div class="garland-light yellow"></div>
        <div class="garland-light purple"></div>
    </div>
    
    <div id="snowfall"></div>


    <!-- –°–ø—ñ–Ω–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
    <div id="notification-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 id="notification-title" class="text-lg font-bold mb-2 text-gray-800"></h3>
            <p id="notification-message" class="text-gray-700 mb-4 break-words"></p>
            <div class="flex justify-end space-x-2">
                <button id="close-notification-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">OK</button>
            </div>
        </div>
    </div>
    <div id="view-edit-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full relative">
            <h3 class="text-lg font-bold mb-2 text-gray-800">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏/–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
            <textarea id="edit-task-input" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-none mb-4" rows="8"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="save-edit-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button id="cancel-edit-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 z-[90] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-2 text-gray-800">–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –¥—ñ—é</h3>
            <p id="confirm-modal-message" class="text-gray-700 mb-4 break-words">–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ?</p>
            <div class="flex justify-end space-x-2">
                <button class="cancel-btn px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="confirm-btn px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors btn-frosty">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="add-friend-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-2 text-gray-800">–î–æ–¥–∞—Ç–∏ –¥—Ä—É–≥–∞</h3>
            <input type="text" id="friend-name-input" placeholder="–Ü–º'—è –¥—Ä—É–≥–∞" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="text" id="friend-id-input" placeholder="ID –¥—Ä—É–≥–∞" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex justify-end space-x-2">
                <button id="save-friend-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button id="cancel-friend-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="assign-task-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full relative">
            <h3 class="text-lg font-bold mb-2 text-gray-800">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
            <select id="friend-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –¥—Ä—É–≥–∞</option>
            </select>
            <textarea id="assign-task-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –¥—Ä—É–≥–∞..." rows="4" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all resize-none mb-4"></textarea>
            <div class="flex justify-end space-x-2">
                <button id="send-task-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                <button id="cancel-assign-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="image-viewer-modal" class="fixed inset-0 z-[60] flex items-center justify-center hidden modal-overlay p-4">
        <div class="bg-white p-2 rounded-lg shadow-xl max-w-4xl max-h-[90vh] w-full h-full relative flex flex-col">
            <button id="close-image-viewer-btn" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 leading-none text-2xl z-10">&times;</button>
            <img id="full-image" src="" class="w-full h-full object-contain">
        </div>
    </div>
    <div id="task-details-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–î–µ—Ç–∞–ª—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
            <p id="task-details-content" class="text-gray-700 mb-6 bg-gray-50 p-4 rounded-md whitespace-pre-wrap break-words"></p>
            <div class="flex justify-between items-center">
                <button id="delete-from-report-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors btn-frosty">–í–∏–¥–∞–ª–∏—Ç–∏ –∑—ñ –∑–≤—ñ—Ç—É</button>
                <button id="close-task-details-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="view-incoming-task-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–í—Ö—ñ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
            <p class="text-sm text-gray-500 mb-2">–í—ñ–¥: <span id="incoming-task-sender" class="font-semibold"></span></p>
            <p id="incoming-task-content" class="text-gray-700 mb-6 bg-gray-50 p-4 rounded-md whitespace-pre-wrap break-words"></p>
            <div class="flex justify-end space-x-2">
                <button id="incoming-task-decline-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors btn-frosty">–í—ñ–¥—Ö–∏–ª–∏—Ç–∏</button>
                <button id="incoming-task-accept-btn" class="px-4 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors btn-frosty">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
                <button id="incoming-task-close-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥—ñ–π —ñ–∑ –∑–∞–≤–¥–∞–Ω–Ω—è–º -->
    <div id="task-actions-modal" class="fixed inset-0 z-[80] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–î—ñ—ó —ñ–∑ –∑–∞–≤–¥–∞–Ω–Ω—è–º</h3>
            <div class="space-y-3">
                <button id="action-activate-btn" class="w-full px-4 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors btn-frosty">–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ñ</button>
                <button id="action-defer-btn" class="w-full px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors btn-frosty">–í —Ä–æ–±–æ—Ç—É</button>
                <button id="action-prolong-btn" class="w-full px-4 py-2 rounded-lg bg-purple-500 text-white font-semibold hover:bg-purple-600 transition-colors hidden btn-frosty">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
                <button id="action-delete-btn" class="w-full px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors btn-frosty">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
            <div class="mt-6 text-right">
                <button id="cancel-actions-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Shelf -->
    <div id="add-shelf-modal" class="fixed inset-0 z-[85] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–ù–æ–≤–∞ –ü–æ–ª–∏—Ü—è</h3>
            <input type="text" id="shelf-name-input" placeholder="–ù–∞–∑–≤–∞ –ø–æ–ª–∏—Ü—ñ (–Ω–∞–ø—Ä. –†–æ–±–æ—Ç–∞)" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex justify-end space-x-2">
                <button id="save-shelf-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button id="cancel-shelf-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Resource Item (Links Only) -->
    <div id="add-resource-modal" class="fixed inset-0 z-[90] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–î–æ–¥–∞—Ç–∏ –ü–æ—Å–∏–ª–∞–Ω–Ω—è</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞</label>
                <input type="text" id="resource-title-input" placeholder="–ù–∞–∑–≤–∞ —Å–∞–π—Ç—É (–Ω–∞–ø—Ä. Google –¢–∞–±–ª–∏—Ü—è)" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">–ü–æ—Å–∏–ª–∞–Ω–Ω—è (URL)</label>
                <input type="text" id="resource-content-input" placeholder="https://example.com" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="flex justify-end space-x-2">
                <button id="save-resource-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–î–æ–¥–∞—Ç–∏</button>
                <button id="cancel-resource-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal: Create Board -->
    <div id="create-board-modal" class="fixed inset-0 z-[85] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–ù–æ–≤–∞ –°–ø—ñ–ª—å–Ω–∞ –î–æ—à–∫–∞</h3>
            <input type="text" id="board-name-input" placeholder="–ù–∞–∑–≤–∞ –¥–æ—à–∫–∏ (–Ω–∞–ø—Ä. –ù–æ–≤–∏–π –†—ñ–∫)" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <div class="flex justify-end space-x-2">
                <button id="save-board-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button id="cancel-board-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Board Member -->
    <div id="add-board-member-modal" class="fixed inset-0 z-[90] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–î–æ–¥–∞—Ç–∏ –£—á–∞—Å–Ω–∏–∫–∞</h3>
            <select id="board-friend-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –¥—Ä—É–≥–∞</option>
            </select>
            <div class="flex justify-end space-x-2">
                <button id="save-board-member-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–î–æ–¥–∞—Ç–∏</button>
                <button id="cancel-board-member-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Sticker -->
    <div id="add-sticker-modal" class="fixed inset-0 z-[95] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–ù–æ–≤–∏–π –°—Ç—ñ–∫–µ—Ä</h3>
            <textarea id="sticker-text-input" placeholder="–¢–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏..." rows="3" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
            <div class="grid grid-cols-4 gap-2 mb-4">
                <div class="h-8 w-8 rounded-full bg-yellow-200 cursor-pointer border-2 border-transparent hover:border-gray-400 color-option" data-color="bg-yellow-200"></div>
                <div class="h-8 w-8 rounded-full bg-blue-200 cursor-pointer border-2 border-transparent hover:border-gray-400 color-option" data-color="bg-blue-200"></div>
                <div class="h-8 w-8 rounded-full bg-green-200 cursor-pointer border-2 border-transparent hover:border-gray-400 color-option" data-color="bg-green-200"></div>
                <div class="h-8 w-8 rounded-full bg-pink-200 cursor-pointer border-2 border-transparent hover:border-gray-400 color-option" data-color="bg-pink-200"></div>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="save-sticker-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–ü—Ä–∏–ª—ñ–ø–∏—Ç–∏</button>
                <button id="cancel-sticker-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Add Complex Task -->
    <div id="add-board-task-modal" class="fixed inset-0 z-[95] flex items-center justify-center hidden modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full relative max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 text-gray-800">–ù–æ–≤–µ –°–ø—ñ–ª—å–Ω–µ –ó–∞–≤–¥–∞–Ω–Ω—è</h3>
            <input type="text" id="board-task-title" placeholder="–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è" class="w-full px-4 py-2 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ï—Ç–∞–ø–∏ (–ø—ñ–¥–∑–∞–≤–¥–∞–Ω–Ω—è):</label>
                <div id="subtasks-container" class="space-y-2 mb-2">
                    <input type="text" placeholder="–ö—Ä–æ–∫ 1" class="subtask-input w-full px-3 py-1.5 rounded border border-gray-200 text-sm">
                </div>
                <button id="add-subtask-field-btn" class="text-sm text-indigo-600 hover:underline">+ –î–æ–¥–∞—Ç–∏ –∫—Ä–æ–∫</button>
            </div>

            <div class="flex justify-end space-x-2">
                <button id="save-board-task-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors btn-frosty">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button id="cancel-board-task-btn" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="main-content" class="max-w-xl w-full">
        <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">–ú—ñ–π –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –ó–∞–≤–¥–∞–Ω—å</h1>
            <p class="text-sm text-gray-500 mb-4 text-center">ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: <span id="user-id-span" class="font-mono break-all">–ù–µ–º–∞—î</span></p>

            <div id="error-message" class="hidden bg-red-100 text-red-700 p-4 rounded-lg mb-4">
                –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó. –ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase –¥–æ–¥–∞–Ω–∞.
            </div>

            <div id="auth-buttons" class="flex flex-col items-center space-y-4 mb-6 hidden">
                <p class="text-gray-500">–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ —Å–≤–æ—ó –∑–∞–≤–¥–∞–Ω–Ω—è.</p>
                <button id="google-signin-btn" class="flex items-center justify-center px-6 py-3 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors shadow-md space-x-2 btn-frosty">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.24 10.232v3.098h5.364c-.183 1.258-1.554 3.738-5.364 3.738-3.21 0-5.815-2.61-5.815-5.82s2.605-5.82 5.815-5.82c1.724 0 2.872.716 3.518 1.346l2.365-2.285c-1.472-1.39-3.41-2.23-5.883-2.23-4.832 0-8.75 3.92-8.75 8.75s3.918 8.75 8.75 8.75c5.035 0 8.358-3.535 8.358-8.528 0-.583-.075-1.127-.183-1.638h-8.175z"/></svg>
                    <span>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</span>
                </button>
            </div>

            <div id="content-section" class="hidden">
                <div class="grid grid-cols-2 gap-2 mb-4 md:grid-cols-4">
                    <button id="report-btn" class="w-full text-center px-2 py-2 rounded-lg bg-teal-500 text-white font-semibold hover:bg-teal-600 transition-colors shadow-md btn-frosty text-sm">–ó–≤—ñ—Ç</button>
                    <button id="chats-btn" class="relative w-full text-center px-2 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors shadow-md btn-frosty text-sm">
                        –ß–∞—Ç–∏
                        <span id="chat-notification-badge" class="absolute top-0 right-0 -mt-2 -mr-2 px-2 py-1 bg-red-600 text-white text-xs rounded-full hidden"></span>
                    </button>
                    <button id="resources-btn" class="w-full text-center px-2 py-2 rounded-lg bg-indigo-500 text-white font-semibold hover:bg-indigo-600 transition-colors shadow-md btn-frosty text-sm">–†–µ—Å—É—Ä—Å–∏</button>
                    <button id="boards-btn" class="w-full text-center px-2 py-2 rounded-lg bg-orange-400 text-white font-semibold hover:bg-orange-500 transition-colors shadow-md btn-frosty text-sm">–î–æ—à–∫–∏</button>
                    <button id="signout-btn" class="col-span-2 md:col-span-4 w-full text-center px-2 py-2 rounded-lg bg-gray-300 text-gray-700 font-semibold hover:bg-gray-400 transition-colors shadow-md btn-frosty text-sm mt-2 md:mt-0">–í–∏–π—Ç–∏</button>
                </div>
                <div class="mb-8">
                    <textarea id="task-input" placeholder="–û–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç—É—Ç..." rows="6" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                         <button id="add-task-btn" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow-md btn-frosty">–î–æ–¥–∞—Ç–∏</button>
                        <button id="assign-task-open-btn" class="px-6 py-2 rounded-lg bg-purple-600 text-white font-semibold hover:bg-purple-700 shadow-md btn-frosty">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6 hidden" id="incoming-tasks-section">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">–í—Ö—ñ–¥–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è (–≤ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—ñ)</h2>
                    <div id="incoming-tasks-list" class="space-y-3"></div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">–ê–∫—Ç–∏–≤–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
                    <div id="active-tasks-list" class="space-y-3 task-list-container"></div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-700">–í —Ä–æ–±–æ—Ç—ñ</h2>
                        <button id="deferred-toggle-btn" class="text-indigo-600 font-semibold hover:underline">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</button>
                    </div>
                    <div id="deferred-tasks-list" class="space-y-3 hidden task-list-container"></div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-700">–í–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
                        <button id="completed-toggle-btn" class="text-indigo-600 font-semibold hover:underline">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</button>
                    </div>
                    <div id="completed-tasks-list" class="space-y-3 hidden task-list-container"></div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-700">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
                        <button id="settings-toggle-btn" class="text-indigo-600 font-semibold hover:underline">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</button>
                    </div>
                    <div id="settings-content" class="hidden space-y-6">
                         <div class="space-y-4">
                             <div>
                                 <label for="deferred-duration" class="block text-sm font-medium text-gray-700">–í —Ä–æ–±–æ—Ç—ñ (–≥–æ–¥–∏–Ω)</label>
                                 <input type="number" step="0.01" id="deferred-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="24">
                             </div>
                             <div>
                                 <label for="stale-duration" class="block text-sm font-medium text-gray-700">–ó–∞—Å—Ç–∞—Ä—ñ–ª–µ –ø—ñ—Å–ª—è (–≥–æ–¥–∏–Ω)</label>
                                 <input type="number" step="0.01" id="stale-duration" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="72">
                             </div>
                             <button id="save-settings-btn" class="w-full px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow-md btn-frosty">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                             <p id="settings-message" class="text-sm text-center text-green-600 hidden"></p>
                         </div>
                         <div class="border-t pt-4">
                            <h3 class="text-lg font-medium text-gray-800 mb-2">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>
                            <button id="enable-notifications-btn" class="w-full px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 shadow-md btn-frosty">–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</button>
                            <p id="notifications-status" class="text-sm text-center text-gray-500 mt-2"></p>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-700">–î—Ä—É–∑—ñ</h2>
                        <button id="friends-toggle-btn" class="text-indigo-600 font-semibold hover:underline">–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏</button>
                    </div>
                    <div id="friends-content" class="hidden">
                        <div class="flex justify-end mb-4">
                            <button id="add-friend-open-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 btn-frosty">–î–æ–¥–∞—Ç–∏ –¥—Ä—É–≥–∞</button>
                        </div>
                        <div id="friends-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°–µ–∫—Ü—ñ—è —á–∞—Ç—É -->
    <div id="chat-section" class="max-w-4xl w-full hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl">
             <button id="back-to-tasks-btn" class="w-full text-center mb-4 px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow-md btn-frosty">–ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å</button>
             <div class="flex flex-col md:flex-row h-[80vh] border rounded-lg">
                <div class="w-full md:w-1/3 border-r bg-gray-50 rounded-l-lg overflow-y-auto">
                    <h2 class="text-xl font-bold p-4 border-b text-gray-700">–î—Ä—É–∑—ñ</h2>
                    <div id="chat-friends-list" class="space-y-1 p-2"></div>
                </div>
                <div class="w-full md:w-2/3 flex flex-col min-h-0">
                    <div id="chat-window-placeholder" class="flex-grow flex items-center justify-center">
                        <p class="text-gray-500">–í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Ç, —â–æ–± –ø–æ—á–∞—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è</p>
                    </div>
                    <div id="chat-window" class="hidden flex-grow flex flex-col overflow-hidden min-h-0">
                         <div id="chat-header" class="p-4 border-b font-bold text-gray-800"></div>
                         <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-100"></div>
                         <div id="upload-progress-container" class="p-4 bg-white border-t hidden">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                         </div>
                         <div class="p-4 bg-white border-t flex items-center space-x-2">
                            <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                            <button id="attach-file-btn" class="p-2 rounded-full hover:bg-gray-200">
                                <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                            </button>
                            <input type="text" id="chat-message-input" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
                            <button id="send-chat-message-btn" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 btn-frosty">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
                         </div>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <!-- –°–µ–∫—Ü—ñ—è –ó–≤—ñ—Ç—É (–¢–∞–±–ª–∏—Ü—è) -->
    <div id="report-section" class="max-w-7xl w-full hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl">
             <button id="back-to-tasks-from-report-btn" class="w-full md:w-auto text-center mb-6 px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow-md btn-frosty">–ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å</button>
             <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">–ó–≤—ñ—Ç –ø–æ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω–Ω—è—Ö</h2>
             <div id="report-content" class="overflow-x-auto">
                <table class="report-table min-w-[800px] md:min-w-full">
                    <thead>
                        <tr>
                            <th class="w-[20%]">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                            <th class="w-[20%]">‚è≥ –û—á—ñ–∫—É—î</th>
                            <th class="w-[20%]">üïê –í —Ä–æ–±–æ—Ç—ñ</th>
                            <th class="w-[20%]">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</th>
                            <th class="w-[20%]">‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body">
                        <!-- –¢—ñ–ª–æ —Ç–∞–±–ª–∏—Ü—ñ –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —Ç—É—Ç -->
                    </tbody>
                </table>
             </div>
        </div>
    </div>
    
    <!-- –°–µ–∫—Ü—ñ—è –†–µ—Å—É—Ä—Å—ñ–≤ -->
    <div id="resources-section" class="max-w-6xl w-full hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl min-h-[80vh]">
             <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                 <button id="back-to-tasks-from-resources-btn" class="w-full md:w-auto text-center px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow-md btn-frosty">–ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å</button>
                 <h2 class="text-2xl font-bold text-gray-800">üìö –ú–æ—ó –†–µ—Å—É—Ä—Å–∏</h2>
                 <button id="add-shelf-btn" class="w-full md:w-auto text-center px-6 py-2 rounded-lg bg-emerald-500 text-white font-semibold hover:bg-emerald-600 shadow-md btn-frosty">
                     <i class="fas fa-plus mr-2"></i>–ù–æ–≤–∞ –ü–æ–ª–∏—Ü—è
                 </button>
             </div>

             <div class="mb-6 relative">
                <input type="text" id="resources-search-input" placeholder="–ü–æ—à—É–∫ –ø–æ—Å–∏–ª–∞–Ω—å..." class="w-full px-4 py-3 pl-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
             </div>
             
             <div id="resources-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 <!-- –ü–æ–ª–∫–∏ –±—É–¥—É—Ç—å —Ç—É—Ç -->
             </div>
        </div>
    </div>
    <div id="editBoardTaskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-96">
            <h3 class="font-bold mb-2 text-lg">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
            <input type="text" id="editBoardTaskTitle" class="w-full mb-2 p-2 border rounded" placeholder="–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è">
            <div id="editSubtasksContainer" class="mb-2"></div>
            <button id="addEditSubtaskBtn" class="mb-2 px-3 py-1 bg-gray-200 rounded text-sm">–î–æ–¥–∞—Ç–∏ –∫—Ä–æ–∫</button>
            <div class="flex justify-end gap-2">
                <button id="cancelEditBoardTaskBtn" class="px-3 py-1 bg-gray-200 rounded">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button id="saveEditBoardTaskBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="editBoardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-96">
            <h3 class="font-bold mb-2 text-lg">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –¥–æ—à–∫—É</h3>
            <input type="text" id="editBoardTitleInput" class="w-full mb-4 p-2 border rounded" placeholder="–ù–∞–∑–≤–∞ –¥–æ—à–∫–∏">
            <div class="flex justify-end gap-2">
                <button id="cancelEditBoardBtn" class="px-3 py-1 bg-gray-200 rounded">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button id="saveEditBoardBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>
    <div id="board-report-modal" class="hidden fixed inset-0 z-[95] flex items-start md:items-center justify-center p-4">
  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[90vh]">
    <div class="flex items-center justify-between p-4 border-b">
      <div class="flex items-center gap-3">
        <h3 id="board-report-title" class="text-lg font-bold">–ó–≤—ñ—Ç –¥–æ—à–∫–∏</h3>
        <span id="board-report-subtitle" class="text-sm text-gray-500"></span>
      </div>
      <div class="flex items-center gap-2">
        <input id="board-report-search" placeholder="–ü–æ—à—É–∫ —É –∑–≤—ñ—Ç—ñ..." class="px-3 py-2 border rounded-md text-sm" />
        <select id="board-report-filter-user" class="px-3 py-2 border rounded-md text-sm">
          <option value="">–£—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</option>
        </select>
        <select id="board-report-filter-type" class="px-3 py-2 border rounded-md text-sm">
          <option value="">–£—Å—ñ —Ç–∏–ø–∏</option>
          <option value="task_added">–î–æ–¥–∞–≤ –∑–∞–≤–¥–∞–Ω–Ω—è</option>
          <option value="subtask_checked">–í–∏–∫—Ä–µ—Å–ª–∏–≤ –ø—É–Ω–∫—Ç</option>
          <option value="subtask_unchecked">–í—ñ–¥–Ω–æ–≤–∏–≤ –ø—É–Ω–∫—Ç</option>
          <option value="sticker_added">–ü—Ä–∏–∫—Ä—ñ–ø–∏–≤ —Å—Ç—ñ–∫–µ—Ä</option>
          <option value="sticker_removed">–ó–Ω—è–≤/–≤–∏–¥–∞–ª–∏–≤ —Å—Ç—ñ–∫–µ—Ä</option>
          <option value="task_deleted">–í–∏–¥–∞–ª–∏–≤ –µ–ª–µ–º–µ–Ω—Ç</option>
        </select>
        <button id="board-report-close" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
    </div>

    <div id="board-report-body" class="mt-6 relative px-4 md:px-0">
    <p id="board-report-empty" class="text-center py-8 text-gray-500 hidden">–£ —Ü—å–æ–º—É –∑–≤—ñ—Ç—ñ –ø–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.</p>
    </div>

    <div class="p-3 border-t text-right">
      <button id="board-report-download" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">–ï–∫—Å–ø–æ—Ä—Ç (JSON)</button>
    </div>
  </div>
</div>
    <!-- –°–µ–∫—Ü—ñ—è Live Boards (–û–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö) -->
    <div id="boards-section" class="max-w-7xl w-full hidden h-[90vh]">
        <div class="bg-white h-full p-6 rounded-2xl shadow-xl flex flex-col">
            <!-- Boards List View -->
            <div id="boards-list-view" class="h-full flex flex-col">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <button id="back-to-tasks-from-boards-btn" class="text-center w-full md:w-auto px-6 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow-md btn-frosty">–ù–∞–∑–∞–¥ –¥–æ –∑–∞–≤–¥–∞–Ω—å</button>
                    <h2 class="text-2xl font-bold text-gray-800">üìã –°–ø—ñ–ª—å–Ω—ñ –î–æ—à–∫–∏</h2>
                    <button id="create-board-btn" class="text-center w-full md:w-auto px-6 py-2 rounded-lg bg-orange-400 text-white font-semibold hover:bg-orange-500 shadow-md btn-frosty">
                        <i class="fas fa-plus mr-2"></i>–°—Ç–≤–æ—Ä–∏—Ç–∏
                    </button>
                </div>
                <div id="boards-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 overflow-y-auto p-2">
                    <!-- –°–ø–∏—Å–æ–∫ –¥–æ—à–æ–∫ -->
                </div>
            </div>

            <!-- Active Board View -->
            <div id="active-board-view" class="hidden h-full flex-col">
                 <div class="flex flex-wrap justify-between items-center mb-4 border-b pb-2 gap-2">
                    <div class="flex items-center gap-4">
                        <button id="back-to-boards-list-btn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-arrow-left text-xl"></i></button>
                        <h2 id="active-board-title" class="text-xl md:text-2xl font-bold text-gray-800 truncate max-w-[200px] md:max-w-full"></h2>
                        <div class="text-sm text-gray-500 flex items-center gap-2">
                            <i class="fas fa-users"></i>
                            <span id="board-member-count">0</span>
                        </div>
                    </div>
                    <button id="add-board-member-btn" class="px-3 py-1 rounded bg-blue-100 text-blue-600 hover:bg-blue-200 text-sm font-medium transition-colors">
                        <i class="fas fa-user-plus mr-1"></i> <span class="hidden md:inline">–î–æ–¥–∞—Ç–∏ –¥—Ä—É–≥–∞</span>
                    </button>
                </div>
                
                <!-- Mobile Tab Switcher -->
                <div class="md:hidden flex mb-2 bg-gray-100 rounded-lg p-1">
                    <button id="mobile-tab-tasks" class="flex-1 py-2 rounded-md bg-white shadow-sm text-indigo-600 font-semibold text-sm transition-all">
                        <i class="fas fa-list-ul mr-2"></i>–ó–∞–≤–¥–∞–Ω–Ω—è
                    </button>
                    <button id="mobile-tab-stickers" class="flex-1 py-2 rounded-md text-gray-500 font-medium text-sm hover:bg-white/50 transition-all">
                        <i class="fas fa-sticky-note mr-2"></i>–°—Ç—ñ–∫–µ—Ä–∏
                    </button>
                </div>
                
                <!-- Canvas Area -->
                <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden relative bg-slate-50 rounded-xl border border-slate-200">
                    <!-- Tasks Column -->
                    <div id="board-tasks-column" class="w-full md:w-1/3 bg-white border-r flex flex-col h-full md:flex">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">‚úÖ –°–ø—ñ–ª—å–Ω—ñ –ó–∞–≤–¥–∞–Ω–Ω—è</h3>
                            <button id="add-board-task-btn" class="text-indigo-600 hover:bg-indigo-50 p-1 rounded"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="board-tasks-list" class="flex-grow overflow-y-auto p-4 space-y-3">
                            <!-- Tasks go here -->
                        </div>
                    </div>
                    
                    <!-- Sticker Area -->
                    <div id="board-stickers-column" class="w-full md:w-2/3 p-6 relative overflow-y-auto h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] hidden md:block">
                        <div class="absolute top-4 right-4 z-20">
                            <button id="add-sticker-btn" class="px-4 py-2 rounded-full bg-yellow-400 text-yellow-900 font-bold shadow-lg hover:bg-yellow-300 hover:scale-105 transition-all transform">
                                <i class="fas fa-sticky-note mr-2"></i>–°—Ç—ñ–∫–µ—Ä
                            </button>
                        </div>
                        <div id="board-stickers-area" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pt-12">
                            <!-- Stickers go here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, setDoc, getDoc, getDocs, where, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

window.onload = function () {
    setLogLevel('debug');

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyB4WVraBbIFYAnqa63xPgxgDRwKar99tdQ",
        authDomain: "planer-test-40ee1.firebaseapp.com",
        projectId: "planer-test-40ee1",
        storageBucket: "planer-test-40ee1.firebasestorage.app",
        messagingSenderId: "68109418592",
        appId: "1:68109418592:web:b072d11b1f80a97fd9c305",
        measurementId: "G-YJJNFTVN1Y"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("YOUR_")) {
        document.getElementById('loading-spinner').classList.add('hidden');
        document.getElementById('error-message').classList.remove('hidden');
        return;
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const getEl = (id) => document.getElementById(id);

    // --- Elements (core) ---
    const mainContent = getEl('main-content'), taskInput = getEl('task-input'), addTaskButton = getEl('add-task-btn'),
          assignTaskOpenBtn = getEl('assign-task-open-btn'), userIdSpan = getEl('user-id-span'),
          loadingSpinner = getEl('loading-spinner'), authButtons = getEl('auth-buttons'),
          contentSection = getEl('content-section'), googleSignInButton = getEl('google-signin-btn'),
          signOutButton = getEl('signout-btn'), confirmModal = getEl('confirm-modal'),
          confirmModalMessage = getEl('confirm-modal-message'), confirmDeleteButton = confirmModal.querySelector('.confirm-btn'),
          cancelDeleteButton = confirmModal.querySelector('.cancel-btn'), notificationModal = getEl('notification-modal'),
          notificationTitle = getEl('notification-title'), notificationMessage = getEl('notification-message'),
          closeNotificationBtn = getEl('close-notification-btn'), viewEditModal = getEl('view-edit-modal'),
          editTaskInput = getEl('edit-task-input'), saveEditBtn = getEl('save-edit-btn'),
          cancelEditBtn = getEl('cancel-edit-btn'), activeTasksList = getEl('active-tasks-list'),
          deferredTasksList = getEl('deferred-tasks-list'), completedTasksList = getEl('completed-tasks-list'),
          deferredToggleBtn = getEl('deferred-toggle-btn'), completedToggleBtn = getEl('completed-toggle-btn'),
          settingsToggleBtn = getEl('settings-toggle-btn'), settingsContent = getEl('settings-content'),
          deferredDurationInput = getEl('deferred-duration'), staleDurationInput = getEl('stale-duration'),
          saveSettingsBtn = getEl('save-settings-btn'), settingsMessage = getEl('settings-message'),
          incomingTasksSection = getEl('incoming-tasks-section'), incomingTasksList = getEl('incoming-tasks-list'),
          friendsToggleBtn = getEl('friends-toggle-btn'), friendsContent = getEl('friends-content'),
          addFriendOpenBtn = getEl('add-friend-open-btn'), friendsList = getEl('friends-list'),
          addFriendModal = getEl('add-friend-modal'), friendNameInput = getEl('friend-name-input'),
          friendIdInput = getEl('friend-id-input'), saveFriendBtn = getEl('save-friend-btn'),
          cancelFriendBtn = getEl('cancel-friend-btn'), assignTaskModal = getEl('assign-task-modal'),
          friendSelect = getEl('friend-select'), assignTaskInput = getEl('assign-task-input'),
          sendTaskBtn = getEl('send-task-btn'), cancelAssignBtn = getEl('cancel-assign-btn'),
          chatsBtn = getEl('chats-btn'), chatNotificationBadge = getEl('chat-notification-badge'),
          chatSection = getEl('chat-section'), backToTasksBtn = getEl('back-to-tasks-btn'),
          chatFriendsList = getEl('chat-friends-list'), chatWindow = getEl('chat-window'),
          chatWindowPlaceholder = getEl('chat-window-placeholder'), chatHeader = getEl('chat-header'),
          chatMessages = getEl('chat-messages'), chatMessageInput = getEl('chat-message-input'),
          sendChatMessageBtn = getEl('send-chat-message-btn'), enableNotificationsBtn = getEl('enable-notifications-btn'),
          notificationsStatus = getEl('notifications-status'), imageViewerModal = getEl('image-viewer-modal'),
          fullImage = getEl('full-image'), closeImageViewerBtn = getEl('close-image-viewer-btn'),
          attachFileBtn = getEl('attach-file-btn'), imageUploadInput = getEl('image-upload-input'),
          uploadProgressContainer = getEl('upload-progress-container'), uploadProgressBar = getEl('upload-progress-bar'),
          reportBtn = getEl('report-btn'), reportSection = getEl('report-section'),
          backToTasksFromReportBtn = getEl('back-to-tasks-from-report-btn'), reportTableBody = getEl('report-table-body'),
          taskDetailsModal = getEl('task-details-modal'), taskDetailsContent = getEl('task-details-content'),
          closeTaskDetailsBtn = getEl('close-task-details-btn'),
          deleteFromReportBtn = getEl('delete-from-report-btn'),
          viewIncomingTaskModal = getEl('view-incoming-task-modal'),
          incomingTaskSender = getEl('incoming-task-sender'),
          incomingTaskContent = getEl('incoming-task-content'),
          incomingTaskAcceptBtn = getEl('incoming-task-accept-btn'),
          incomingTaskDeclineBtn = getEl('incoming-task-decline-btn'),
          incomingTaskCloseBtn = getEl('incoming-task-close-btn'),
          taskActionsModal = getEl('task-actions-modal'),
          actionDeferBtn = getEl('action-defer-btn'),
          actionActivateBtn = getEl('action-activate-btn'),
          actionProlongBtn = getEl('action-prolong-btn'),
          actionDeleteBtn = getEl('action-delete-btn'),
          cancelActionsBtn = getEl('cancel-actions-btn'),
          resourcesBtn = getEl('resources-btn'), resourcesSection = getEl('resources-section'),
          backToTasksFromResourcesBtn = getEl('back-to-tasks-from-resources-btn'),
          resourcesGrid = getEl('resources-grid'), addShelfBtn = getEl('add-shelf-btn'),
          addShelfModal = getEl('add-shelf-modal'), shelfNameInput = getEl('shelf-name-input'),
          saveShelfBtn = getEl('save-shelf-btn'), cancelShelfBtn = getEl('cancel-shelf-btn'),
          addResourceModal = getEl('add-resource-modal'), resourceTitleInput = getEl('resource-title-input'),
          resourceContentInput = getEl('resource-content-input'),
          saveResourceBtn = getEl('save-resource-btn'), cancelResourceBtn = getEl('cancel-resource-btn'),
          resourcesSearchInput = getEl('resources-search-input');

    const boardsBtn = getEl('boards-btn'), boardsSection = getEl('boards-section'),
          backToTasksFromBoardsBtn = getEl('back-to-tasks-from-boards-btn'),
          boardsGrid = getEl('boards-grid'), createBoardBtn = getEl('create-board-btn'),
          createBoardModal = getEl('create-board-modal'), boardNameInput = getEl('board-name-input'),
          saveBoardBtn = getEl('save-board-btn'), cancelBoardBtn = getEl('cancel-board-btn'),
          boardsListView = getEl('boards-list-view'), activeBoardView = getEl('active-board-view'),
          activeBoardTitle = getEl('active-board-title'), backToBoardsListBtn = getEl('back-to-boards-list-btn'),
          addBoardMemberBtn = getEl('add-board-member-btn'), addBoardMemberModal = getEl('add-board-member-modal'),
          boardFriendSelect = getEl('board-friend-select'), saveBoardMemberBtn = getEl('save-board-member-btn'),
          cancelBoardMemberBtn = getEl('cancel-board-member-btn'),
          boardTasksList = getEl('board-tasks-list'), addBoardTaskBtn = getEl('add-board-task-btn'),
          addBoardTaskModal = getEl('add-board-task-modal'), boardTaskTitle = getEl('board-task-title'),
          subtasksContainer = getEl('subtasks-container'), addSubtaskFieldBtn = getEl('add-subtask-field-btn'),
          saveBoardTaskBtn = getEl('save-board-task-btn'), cancelBoardTaskBtn = getEl('cancel-board-task-btn'),
          boardStickersArea = getEl('board-stickers-area'), addStickerBtn = getEl('add-sticker-btn'),
          addStickerModal = getEl('add-sticker-modal'), stickerTextInput = getEl('sticker-text-input'),
          saveStickerBtn = getEl('save-sticker-btn'), cancelStickerBtn = getEl('cancel-sticker-btn'),
          mobileTabTasks = getEl('mobile-tab-tasks'), mobileTabStickers = getEl('mobile-tab-stickers'),
          boardTasksColumn = getEl('board-tasks-column'), boardStickersColumn = getEl('board-stickers-column');

    // --- Edit board/task modals ---
    let currentEditingTask = null;
    const editBoardTaskModal = getEl('editBoardTaskModal');
    const editBoardTaskTitle = getEl('editBoardTaskTitle');
    const editSubtasksContainer = getEl('editSubtasksContainer');
    const addEditSubtaskBtn = getEl('addEditSubtaskBtn');
    const cancelEditBoardTaskBtn = getEl('cancelEditBoardTaskBtn');
    const saveEditBoardTaskBtn = getEl('saveEditBoardTaskBtn');

    let currentEditingBoard = null;
    const editBoardModal = getEl('editBoardModal');
    const editBoardTitleInput = getEl('editBoardTitleInput');
    const cancelEditBoardBtn = getEl('cancelEditBoardBtn');
    const saveEditBoardBtn = getEl('saveEditBoardBtn');

    // --- State ---
    let userId = null, currentAction = null, deferredDurationHours = 24, staleDurationHours = 72,
        currentTaskToEdit = null, selectedFriendForChat = null, unsubscribeFromChat = null,
        friendsCache = {}, shownNotifications = new Set(),
        unsubscribeFromReport = null, currentReportTaskIdToDelete = null,
        currentIncomingTask = null, currentTaskForAction = null,
        unsubscribeFromResources = null, currentShelfIdForResource = null,
        currentShelvesData = [],
        unsubscribeFromBoards = null, unsubscribeFromBoardItems = null, currentBoardId = null,
        selectedStickerColor = 'bg-yellow-200', currentMobileTab = 'tasks';

    // --- Helper functions (generic) ---
    const signInWithGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error("Sign-in error:", error); } };
    const signOutUser = async () => { try { await signOut(auth); } catch (error) { console.error("Sign-out error:", error); } };
    const showNotification = (title, message) => { notificationTitle.textContent = title; notificationMessage.textContent = message; notificationModal.classList.remove('hidden'); };
    const hideNotification = () => notificationModal.classList.add('hidden');
    const showPushNotification = (title, options) => { if (document.hidden && Notification.permission === 'granted') { new Notification(title, options); } };

    function debounce(fn, wait) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; }

    // display name resolution per requirement: use friendsCache -> local name the user assigned
    const getDisplayNameFor = (uid) => {
        if (!uid) return '–ù–µ–≤—ñ–¥–æ–º–∏–π';
        if (uid === userId) return (auth.currentUser?.displayName || '–í–∏');
        if (friendsCache[uid] && friendsCache[uid].name) return friendsCache[uid].name;
        // fallback to short uid
        return uid.substring(0,6) + '...';
    };

    const getInitials = (uid) => {
        const name = getDisplayNameFor(uid);
        const parts = name.split(/\s+/).filter(Boolean);
        if (parts.length === 0) return name.slice(0,2).toUpperCase();
        if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
        return (parts[0][0] + parts[1][0]).toUpperCase();
    };

    const colorForUid = (uid) => {
        const colors = ['#6366f1','#ef4444','#f97316','#059669','#0ea5e9','#8b5cf6','#db2777','#eab308'];
        let hash = 0;
        for (let i=0;i<uid.length;i++) hash = (hash<<5)-hash + uid.charCodeAt(i);
        return colors[Math.abs(hash) % colors.length];
    };

    const fmtTime = (ts) => {
        if (!ts) return '';
        const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
        return d.toLocaleString();
    };

    // --- Settings load ---
    const loadSettings = async () => {
        if (!userId) return;
        try {
            const settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/app_settings`);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists()) {
                const settings = docSnap.data();
                deferredDurationHours = settings.deferredDurationHours || 24;
                staleDurationHours = settings.staleDurationHours || 72;
                if (settings.expandedSections) {
                    Object.entries(settings.expandedSections).forEach(([key, isExpanded]) => {
                        const list = getEl(`${key}-tasks-list`) || getEl(`${key}-content`);
                        const btn = getEl(`${key}-toggle-btn`);
                        if (list && btn) { list.classList.toggle('hidden', !isExpanded); btn.textContent = isExpanded ? '–ó–≥–æ—Ä–Ω—É—Ç–∏' : '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏'; }
                    });
                }
            }
            deferredDurationInput.value = deferredDurationHours;
            staleDurationInput.value = staleDurationHours;
        } catch (e) { console.error("Error loading settings:", e); }
    };

    // --- Tasks subscription & rendering ---
    const subscribeToTasks = () => {
        if (!db || !userId) return;
        const q = query(collection(db, `artifacts/${appId}/users/${userId}/tasks`), orderBy("createdAt", "desc"));
        onSnapshot(q, (querySnapshot) => {
            const tasks = { active: [], deferred: [], completed: [] };
            querySnapshot.forEach(async (docSnap) => {
                const task = { id: docSnap.id, ...docSnap.data(), ref: docSnap.ref };
                if (task.status === 'deferred' && task.deferredAt) {
                    if (Date.now() - task.deferredAt.toMillis() >= deferredDurationHours * 3600000) {
                        await updateTaskStatus(task.id, 'active', task.originalSharedTaskId);
                        showPushNotification('–ó–∞–≤–¥–∞–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω—É—Ç–æ –¥–æ –∞–∫—Ç–∏–≤–Ω–∏—Ö', { body: `–ó–∞–≤–¥–∞–Ω–Ω—è: "${task.text}"` });
                        return;
                    }
                }
                if (task.status === 'active' && task.lastUpdatedAt) {
                   if (Date.now() - task.lastUpdatedAt.toMillis() >= staleDurationHours * 3600000 && !task.isStale) {
                        await updateDoc(task.ref, { isStale: true });
                        task.isStale = true;
                        showPushNotification('–ó–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–∞–ª–æ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–º', { body: `–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É –Ω–∞ –∑–∞–≤–¥–∞–Ω–Ω—è: "${task.text}"` });
                    }
                }
                (tasks[task.status] || tasks.active).push(task);
            });
            renderTasks(tasks.active, activeTasksList, 'active');
            renderTasks(tasks.deferred, deferredTasksList, 'deferred');
            renderTasks(tasks.completed, completedTasksList, 'completed');
        }, error => console.error("Error in tasks subscription: ", error));
    };

    const renderTasks = (tasks, listElement, status) => {
        listElement.innerHTML = '';
        if (!tasks || tasks.length === 0) {
            const messages = { active: '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å.', deferred: '–ù–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å –≤ —Ä–æ–±–æ—Ç—ñ.', completed: '–ù–µ–º–∞—î –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å.' };
            listElement.innerHTML = `<p class="text-gray-500 text-center italic">${messages[status]}</p>`;
            return;
        }
        tasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = `p-4 rounded-xl shadow-md flex items-start justify-between ${task.isStale ? 'bg-red-100' : 'bg-white'} space-x-2`;
            let buttonsHTML = status === 'completed' 
                ? `<button class="active-btn px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 btn-frosty">–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏</button>`
                : `<button class="complete-btn px-4 py-2 rounded-lg bg-green-500 text-white font-semibold hover:bg-green-600 btn-frosty">–í–∏–∫–æ–Ω–∞–Ω–æ</button>
                   <button class="more-options-btn p-2 rounded-full hover:bg-gray-200">...</button>`;
            
            taskItem.innerHTML = `
                <div class="flex-grow min-w-0">
                    <p class="text-gray-800 cursor-pointer text-truncate-2 break-words">${task.text}</p>
                </div>
                <div class="flex-shrink-0 flex items-center space-x-2">${buttonsHTML}</div>`;
            
            if (status !== 'completed') {
                const moreBtn = taskItem.querySelector('.more-options-btn');
                if (moreBtn) moreBtn.addEventListener('click', (e) => { e.stopPropagation(); showTaskActionsModal(task); });
            }
            taskItem.querySelector('p').addEventListener('click', () => showViewEditModal(task));
            if (taskItem.querySelector('.complete-btn')) taskItem.querySelector('.complete-btn').addEventListener('click', () => updateTaskStatus(task.id, 'completed', task.originalSharedTaskId));
            if (taskItem.querySelector('.active-btn')) taskItem.querySelector('.active-btn').addEventListener('click', () => updateTaskStatus(task.id, 'active', task.originalSharedTaskId));
            listElement.appendChild(taskItem);
        });
    };

    const addTask = async () => {
        const taskText = taskInput.value.trim();
        if (taskText === '' || !userId) return;
        try {
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), { text: taskText, status: 'active', createdAt: serverTimestamp(), lastUpdatedAt: serverTimestamp(), isStale: false });
            taskInput.value = '';
        } catch (e) { console.error("Error adding task: ", e); }
    };

    const updateTaskStatus = async (id, newStatus, originalSharedTaskId = null) => {
        if (!userId) return;
        try {
            let updateData = { status: newStatus, lastUpdatedAt: serverTimestamp(), isStale: false };
            if (newStatus === 'deferred') updateData.deferredAt = serverTimestamp();
            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, id), updateData);

            if (originalSharedTaskId) {
                const publicTaskRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_tasks', originalSharedTaskId);
                let publicStatus = (newStatus === 'active' || newStatus === 'deferred') ? 'accepted' : newStatus;
                await updateDoc(publicTaskRef, { status: publicStatus });
            }
        } catch (e) { console.error("Error updating task status: ", e); }
    };

    const prolongTask = async (id) => { if (!userId) return; try { await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, id), { lastUpdatedAt: serverTimestamp(), isStale: false }); } catch (e) { console.error("Error prolonging task:", e); } };

    const saveSettings = async () => { 
        if (!userId) return; 
        const newDeferred = parseFloat(deferredDurationInput.value); 
        const newStale = parseFloat(staleDurationInput.value); 
        if (isNaN(newDeferred) || newDeferred < 0 || isNaN(newStale) || newStale < 0) { settingsMessage.textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–π—Å–Ω—ñ —á–∏—Å–ª–∞."; settingsMessage.className = 'text-sm text-center text-red-600'; return; } 
        try { 
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/settings/app_settings`), { deferredDurationHours: newDeferred, staleDurationHours: newStale }, { merge: true }); 
            deferredDurationHours = newDeferred; staleDurationHours = newStale; 
            settingsMessage.textContent = "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ."; settingsMessage.className = 'text-sm text-center text-green-600 visible'; 
            setTimeout(() => settingsMessage.classList.remove('visible'), 3000); 
        } catch (e) { console.error("Error saving settings:", e); } 
    };

    const saveExpansionState = async () => { 
        if (!userId) return; 
        const sections = { deferred: !deferredTasksList.classList.contains('hidden'), completed: !completedTasksList.classList.contains('hidden'), settings: !settingsContent.classList.contains('hidden'), friends: !friendsContent.classList.contains('hidden') }; 
        try { const settingsRef = doc(db, `artifacts/${appId}/users/${userId}/settings/app_settings`); await setDoc(settingsRef, { expandedSections: sections }, { merge: true }); } catch (e) { console.error("Error saving expansion state:", e); } 
    };

    const showConfirmModal = (action, message, buttonText) => { currentAction = action; confirmModalMessage.textContent = message; confirmDeleteButton.textContent = buttonText; confirmModal.classList.remove('hidden'); };
    const hideConfirmModal = () => { confirmModal.classList.add('hidden'); currentAction = null; };

    const deleteTask = async (task) => { 
        if (!userId || !task || !task.id) return; 
        try { 
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, task.id)); 
            if (task.originalSharedTaskId) { 
                const publicTaskRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_tasks', task.originalSharedTaskId); 
                await updateDoc(publicTaskRef, { status: 'declined' }); 
            } 
        } catch (e) { console.error("Error processing task deletion: ", e); showNotification('–ü–æ–º–∏–ª–∫–∞', '–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.'); } 
    };

    const deleteChatMessage = async (msg) => { 
        if (!userId || !msg.id || msg.senderId !== userId) return; 
        try { 
            const publicDataRef = doc(db, 'artifacts', appId, 'public', 'data'); 
            await deleteDoc(doc(collection(publicDataRef, 'chat_messages'), msg.id)); 
            if (msg.type === 'image' && msg.imageUrl) { 
                const imageRef = ref(storage, msg.imageUrl); 
                await deleteObject(imageRef); 
            } 
        } catch (e) { console.error("Error deleting chat message:", e); } 
    };

    const showViewEditModal = (task) => { currentTaskToEdit = task; editTaskInput.value = task.text; viewEditModal.classList.remove('hidden'); };
    const hideViewEditModal = () => { viewEditModal.classList.add('hidden'); currentTaskToEdit = null; };
    const saveEditedTask = async () => { 
        if (!userId || !currentTaskToEdit) return; 
        const newText = editTaskInput.value.trim(); 
        if (newText === '') { showNotification('–ü–æ–º–∏–ª–∫–∞', '–¢–µ–∫—Å—Ç –∑–∞–≤–¥–∞–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º.'); return; } 
        try { await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, currentTaskToEdit.id), { text: newText, lastUpdatedAt: serverTimestamp() }); hideViewEditModal(); } catch (e) { console.error("Error updating task:", e); } 
    };

    const showAddFriendModal = () => { friendNameInput.value = ''; friendIdInput.value = ''; addFriendModal.classList.remove('hidden'); };
    const hideAddFriendModal = () => { addFriendModal.classList.add('hidden'); };
    const saveFriend = async () => { 
        const name = friendNameInput.value.trim(); 
        const friendId = friendIdInput.value.trim(); 
        if (name === '' || friendId === '' || friendId === userId) return; 
        try { await setDoc(doc(db, `artifacts/${appId}/users/${userId}/friends`, friendId), { name, userId: friendId }); hideAddFriendModal(); } catch (e) { console.error("Error adding friend:", e); } 
    };
    const deleteFriend = async (friendId) => { 
        if (!userId || !friendId) return; 
        try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/friends`, friendId)); } catch (e) { console.error("Error deleting friend:", e); showNotification('–ü–æ–º–∏–ª–∫–∞', '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –¥—Ä—É–≥–∞.'); } 
    };

    const subscribeToFriends = () => { 
        if (!userId) return; 
        try { onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/friends`), (snapshot) => { friendsCache = {}; snapshot.docs.forEach(d => friendsCache[d.id] = d.data()); renderFriends(Object.values(friendsCache)); renderChatFriends(Object.values(friendsCache)); }, error => console.error("Error in friends subscription:", error)); } catch (e) { console.error("Error subscribing to friends:", e); } 
    };

    const renderFriends = (friends) => { 
        friendsList.innerHTML = ''; friendSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –¥—Ä—É–≥–∞</option>'; 
        if (friends.length === 0) { friendsList.innerHTML = `<p class="text-gray-500 text-center italic">–ù–µ–º–∞—î –¥—Ä—É–∑—ñ–≤.</p>`; return; } 
        friends.forEach(friend => { 
            const friendItem = document.createElement('div'); friendItem.className = 'p-3 rounded-lg bg-white shadow-md flex justify-between items-center'; 
            friendItem.innerHTML = `<div><p class="font-semibold text-gray-800">${friend.name}</p><p class="text-sm text-gray-500 break-all">${friend.userId}</p></div><button class="delete-friend-btn p-2 rounded-full hover:bg-red-100 text-red-500"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`; 
            friendItem.querySelector('.delete-friend-btn').addEventListener('click', () => { showConfirmModal(() => deleteFriend(friend.userId), `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ ${friend.name} –∑—ñ —Å–ø–∏—Å–∫—É –¥—Ä—É–∑—ñ–≤?`, "–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏"); }); 
            friendsList.appendChild(friendItem); friendSelect.innerHTML += `<option value="${friend.userId}">${friend.name}</option>`; 
        }); 
    };

    const renderChatFriends = (friends) => { chatFriendsList.innerHTML = friends.length === 0 ? `<p class="text-gray-500 text-center italic p-4">–ù–µ–º–∞—î –¥—Ä—É–∑—ñ–≤ –¥–ª—è —á–∞—Ç—É.</p>` : ''; friends.forEach(friend => { const friendItem = document.createElement('div'); friendItem.className = 'p-3 rounded-lg hover:bg-indigo-100 cursor-pointer flex items-center justify-between'; friendItem.innerHTML = `<div class="font-semibold text-gray-800 flex-grow">${friend.name}</div><span id="unread-count-${friend.userId}" class="px-2 py-1 bg-red-600 text-white text-xs rounded-full hidden"></span>`; friendItem.addEventListener('click', () => selectFriendForChat(friend)); chatFriendsList.appendChild(friendItem); }); };

    const showAssignTaskModal = () => { assignTaskInput.value = ''; friendSelect.value = ''; assignTaskModal.classList.remove('hidden'); };
    const hideAssignTaskModal = () => { assignTaskModal.classList.add('hidden'); };
    const sendAssignedTask = async () => { 
        const recipientId = friendSelect.value; const taskText = assignTaskInput.value.trim(); 
        if (recipientId === '' || taskText === '') return; 
        try { 
            const sharedTasksCollection = collection(db, 'artifacts', appId, 'public', 'data', 'shared_tasks'); 
            await addDoc(sharedTasksCollection, { text: taskText, senderId: userId, senderName: auth.currentUser.displayName || '–ê–Ω–æ–Ω—ñ–º', recipientId, createdAt: serverTimestamp(), status: 'pending' }); 
            const selectedFriend = { userId: recipientId, name: friendSelect.options[friendSelect.selectedIndex].text }; 
            await sendChatMessage({ text: `–Ø –ø—Ä–∏–∑–Ω–∞—á–∏–≤ –≤–∞–º –∑–∞–≤–¥–∞–Ω–Ω—è: "${taskText}"`, recipient: selectedFriend, isTask: true }); 
            hideAssignTaskModal(); 
        } catch (e) { console.error("Error sending assigned task:", e); } 
    };

    const subscribeToIncomingTasks = () => { 
        if (!userId) return; 
        const sharedTasksCollection = collection(db, 'artifacts', appId, 'public', 'data', 'shared_tasks'); 
        const q = query(sharedTasksCollection, where("recipientId", "==", userId), where("status", "==", "pending")); 
        onSnapshot(q, (snapshot) => { const tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); tasks.sort((a,b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)); renderIncomingTasks(tasks); }, error => console.error("Error in incoming tasks subscription:", error)); 
    };

    const renderIncomingTasks = (tasks) => { 
        incomingTasksList.innerHTML = ''; 
        if (tasks.length === 0) { incomingTasksSection.style.display = 'none'; return; } 
        incomingTasksSection.style.display = 'block'; 
        tasks.forEach(task => { 
            const taskItem = document.createElement('div'); taskItem.className = 'p-4 rounded-xl shadow-md bg-white flex items-center justify-between space-x-2'; taskItem.innerHTML = `<div class="flex-grow cursor-pointer min-w-0"><p class="text-sm text-gray-500">–í—ñ–¥: <span class="font-semibold">${task.senderName}</span></p><p class="text-gray-800 break-words">${task.text}</p></div><div class="flex-shrink-0"><button class="view-incoming-task-btn px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold btn-frosty">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button></div>`; taskItem.querySelector('.view-incoming-task-btn').addEventListener('click', () => showViewIncomingTaskModal(task)); taskItem.querySelector('.flex-grow').addEventListener('click', () => showViewIncomingTaskModal(task)); incomingTasksList.appendChild(taskItem); }); 
    };

    const acceptIncomingTask = async (task) => { 
        if (!userId) return; 
        try { 
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tasks`), { text: task.text, status: 'active', createdAt: serverTimestamp(), lastUpdatedAt: serverTimestamp(), isStale: false, assignedBy: task.senderName, originalSharedTaskId: task.id }); 
            await updateSharedTaskStatus(task.id, 'accepted'); 
        } catch (e) { console.error("Error accepting task:", e); } 
    };

    const updateSharedTaskStatus = async (taskId, status) => { try { const taskRef = doc(db, 'artifacts', appId, 'public', 'data', 'shared_tasks', taskId); await updateDoc(taskRef, { status }); } catch (e) { console.error(`Error updating shared task to ${status}:`, e); } };

    const openChatView = () => { mainContent.classList.add('hidden'); chatSection.classList.remove('hidden'); };
    const closeChatView = () => { chatSection.classList.add('hidden'); mainContent.classList.remove('hidden'); if (unsubscribeFromChat) unsubscribeFromChat(); unsubscribeFromChat = null; selectedFriendForChat = null; chatWindow.classList.add('hidden'); chatWindowPlaceholder.classList.remove('hidden'); };

    const selectFriendForChat = async (friend) => {
        selectedFriendForChat = friend;
        chatWindowPlaceholder.classList.add('hidden');
        chatWindow.classList.remove('hidden');
        chatHeader.textContent = `–ß–∞—Ç –∑ ${friend.name}`;
        chatMessages.innerHTML = '';
        if (unsubscribeFromChat) unsubscribeFromChat();
        const participants = [userId, friend.userId].sort();
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), where("participants", "==", participants), orderBy("timestamp"));
        unsubscribeFromChat = onSnapshot(q, (snapshot) => {
            chatMessages.innerHTML = '';
            snapshot.docs.forEach(d => renderChatMessage({ id: d.id, ...d.data() }));
            setTimeout(() => { chatMessages.scrollTop = chatMessages.scrollHeight; }, 0);
        }, error => console.error("Chat subscription error:", error));
        await markMessagesAsRead(friend.userId);
    };

    const markMessagesAsRead = async (friendId) => {
        if (!userId || !friendId) return;
        const participants = [userId, friendId].sort();
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), where("participants", "==", participants));
        try {
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach(docSnapshot => {
                const message = docSnapshot.data();
                if (message.readBy && !message.readBy.includes(userId)) {
                    batch.update(docSnapshot.ref, { readBy: arrayUnion(userId) });
                }
            });
            await batch.commit();
        } catch (e) { console.error("Error marking messages as read:", e); }
    };

    const subscribeToUnreadCounts = () => {
        if (!userId) return;
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), where("participants", "array-contains", userId));
        onSnapshot(q, (snapshot) => {
            const unreadCounts = {}, unreadSenders = new Set();
            snapshot.docs.forEach(d => {
                const message = { id: d.id, ...d.data() };
                if (message.readBy && !message.readBy.includes(userId)) {
                    const friendId = message.participants.find(id => id !== userId);
                    if (friendId) {
                        unreadCounts[friendId] = (unreadCounts[friendId] || 0) + 1;
                        unreadSenders.add(friendId);
                        if (!shownNotifications.has(message.id)) {
                            const friendName = friendsCache[friendId]?.name || '–î—Ä—É–≥';
                            showPushNotification(`–ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ ${friendName}`, { body: message.text || '[–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è]' });
                            shownNotifications.add(message.id);
                        }
                    }
                }
            });
            updateUnreadBadges(unreadCounts, unreadSenders.size);
        }, error => console.error("Unread counts subscription error:", error));
    };

    const updateUnreadBadges = (counts, totalSenders) => {
        chatNotificationBadge.textContent = totalSenders;
        chatNotificationBadge.classList.toggle('hidden', totalSenders === 0);
        Object.values(friendsCache).forEach(friend => {
            const badge = document.getElementById(`unread-count-${friend.userId}`);
            if (badge) {
                const count = counts[friend.userId];
                badge.textContent = count;
                badge.classList.toggle('hidden', !count);
            }
        });
    };

    const renderChatMessage = (message) => {
        const msgDiv = document.createElement('div');
        const isSentByMe = message.senderId === userId;
        msgDiv.className = `flex ${isSentByMe ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `message-bubble p-3 rounded-lg max-w-xs md:max-w-md break-words relative group ${isSentByMe ? 'bg-indigo-500 text-white' : 'bg-gray-200 text-gray-800'}`;
        if (message.isTask) {
            bubble.className = 'message-bubble p-3 rounded-lg max-w-xs md:max-w-md break-words relative bg-yellow-200 text-yellow-800 border border-yellow-300 text-sm italic mx-auto';
            msgDiv.className = 'flex justify-center';
            bubble.textContent = message.text;
        } else if (message.type === 'image' && message.imageUrl) {
            const img = document.createElement('img');
            img.src = message.imageUrl;
            img.className = "max-w-[200px] rounded-lg cursor-pointer max-h-48";
            img.addEventListener('click', () => showImageViewer(message.imageUrl));
            bubble.appendChild(img);
        } else {
            bubble.textContent = message.text;
        }
        if (isSentByMe && !message.isTask) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-msg-btn absolute top-1/2 -left-8 transform -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded-full bg-gray-300 hover:bg-red-500 text-white';
            deleteBtn.innerHTML = '<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>';
            deleteBtn.addEventListener('click', () => showConfirmModal(() => deleteChatMessage(message), "–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?", "–í–∏–¥–∞–ª–∏—Ç–∏"));
            bubble.appendChild(deleteBtn);
        }
        msgDiv.appendChild(bubble);
        chatMessages.appendChild(msgDiv);
    };

    const showImageViewer = (url) => { fullImage.src = url; imageViewerModal.classList.remove('hidden'); };

    const sendChatMessage = async (options) => {
        const { text, recipient, isTask = false, imageUrl = null } = options;
        const messageText = text ? text.trim() : '';
        if (messageText === '' && !imageUrl) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), { participants: [userId, recipient.userId].sort(), text: messageText, senderId: userId, timestamp: serverTimestamp(), isTask, readBy: [userId], type: imageUrl ? 'image' : 'text', imageUrl });
            if (!isTask) chatMessageInput.value = '';
        } catch (e) { console.error("Error sending chat message: ", e); }
    };

    const uploadImageAndSendMessage = (file) => {
        if (!file || !selectedFriendForChat) return;
        const participants = [userId, selectedFriendForChat.userId].sort();
        const storageRef = ref(storage, `chats/${participants.join('_')}/${Date.now()}-${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        uploadProgressContainer.classList.remove('hidden');
        uploadTask.on('state_changed', (snapshot) => { uploadProgressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`; }, (error) => { console.error("Upload error:", error); uploadProgressContainer.classList.add('hidden'); }, () => {
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => { sendChatMessage({ recipient: selectedFriendForChat, imageUrl: downloadURL }); uploadProgressContainer.classList.add('hidden'); });
        });
    };

    const checkNotificationStatus = () => { if (!('Notification' in window)) { notificationsStatus.textContent = "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è."; enableNotificationsBtn.disabled = true; return; } const permission = Notification.permission; notificationsStatus.textContent = permission === 'granted' ? "–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ." : permission === 'denied' ? "–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ." : "–ù–∞–¥–∞–π—Ç–µ –¥–æ–∑–≤—ñ–ª."; enableNotificationsBtn.disabled = permission !== 'default'; };
    const requestNotificationPermission = async () => { const permission = await Notification.requestPermission(); if (permission === 'granted') { new Notification("–î—è–∫—É—î–º–æ!", { body: "–¢–µ–ø–µ—Ä –≤–∏ –±—É–¥–µ—Ç–µ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è." }); } checkNotificationStatus(); };

    // --- Report (existing shared tasks report) ---
    const openReportView = () => { mainContent.classList.add('hidden'); reportSection.classList.remove('hidden'); subscribeToReport(); };
    const closeReportView = () => { reportSection.classList.add('hidden'); mainContent.classList.remove('hidden'); if (unsubscribeFromReport) unsubscribeFromReport(); unsubscribeFromReport = null; };
    const subscribeToReport = () => { if (!userId) return; if (unsubscribeFromReport) unsubscribeFromReport(); const sharedTasksCollection = collection(db, 'artifacts', appId, 'public', 'data', 'shared_tasks'); const q = query(sharedTasksCollection, where("senderId", "==", userId)); unsubscribeFromReport = onSnapshot(q, (snapshot) => { const tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); tasks.sort((a,b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0)); renderReport(tasks); }, error => console.error("Error in report subscription:", error)); };
    const renderReport = (tasks) => {
        reportTableBody.innerHTML = '';
        if (Object.keys(friendsCache).length === 0 && tasks.length > 0) { setTimeout(() => renderReport(tasks), 100); return; }
        const tasksByRecipient = {};
        tasks.forEach(task => { if (!tasksByRecipient[task.recipientId]) tasksByRecipient[task.recipientId] = []; tasksByRecipient[task.recipientId].push(task); });
        if (Object.keys(tasksByRecipient).length === 0) { reportTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 italic py-8">–í–∏ —â–µ –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–∏–ª–∏ –∂–æ–¥–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è.</td></tr>`; return; }
        for (const recipientId in tasksByRecipient) {
            const userTasks = tasksByRecipient[recipientId];
            const friendName = friendsCache[recipientId]?.name || `–ù–µ–≤—ñ–¥–æ–º–∏–π (${recipientId.substring(0,5)}...)`;
            const row = document.createElement('tr');
            const statuses = ['pending', 'accepted', 'completed', 'declined'];
            let cellsHTML = statuses.map(status => {
                const tasksInStatus = userTasks.filter(t => t.status === status);
                const cardsHTML = tasksInStatus.map(task => `<div class="report-task-card p-2 mb-2 bg-white rounded-md shadow-sm border" data-task-text="${escape(task.text)}" data-task-id="${task.id}"><p class="text-sm break-words">${task.text}</p></div>`).join('');
                return `<td class="align-top">${cardsHTML || ''}</td>`;
            }).join('');
            row.innerHTML = `<td>${friendName}</td>${cellsHTML}`;
            reportTableBody.appendChild(row);
        }
    };

    const showTaskDetailsModal = (taskText, taskId) => { taskDetailsContent.textContent = unescape(taskText); currentReportTaskIdToDelete = taskId; taskDetailsModal.classList.remove('hidden'); };
    const hideTaskDetailsModal = () => { taskDetailsModal.classList.add('hidden'); currentReportTaskIdToDelete = null; };
    const deleteSharedTaskFromReport = async () => { if (!currentReportTaskIdToDelete) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shared_tasks', currentReportTaskIdToDelete)); hideTaskDetailsModal(); } catch (e) { console.error("Error deleting task from report: ", e); } };

    const showViewIncomingTaskModal = (task) => { currentIncomingTask = task; incomingTaskSender.textContent = task.senderName; incomingTaskContent.textContent = task.text; viewIncomingTaskModal.classList.remove('hidden'); };
    const hideViewIncomingTaskModal = () => { viewIncomingTaskModal.classList.add('hidden'); currentIncomingTask = null; };
    const showTaskActionsModal = (task) => { currentTaskForAction = task; actionDeferBtn.classList.toggle('hidden', task.status === 'deferred'); actionActivateBtn.classList.toggle('hidden', task.status !== 'deferred'); actionProlongBtn.classList.toggle('hidden', !task.isStale); taskActionsModal.classList.remove('hidden'); };
    const hideTaskActionsModal = () => { taskActionsModal.classList.add('hidden'); currentTaskForAction = null; };

    // --- Resources ---
    const openResourcesView = () => { mainContent.classList.add('hidden'); resourcesSection.classList.remove('hidden'); subscribeToResources(); };
    const closeResourcesView = () => { resourcesSection.classList.add('hidden'); mainContent.classList.remove('hidden'); if (unsubscribeFromResources) unsubscribeFromResources(); unsubscribeFromResources = null; };

    const subscribeToResources = () => { if (!userId) return; const q = query(collection(db, `artifacts/${appId}/users/${userId}/resources`), orderBy("createdAt", "desc")); unsubscribeFromResources = onSnapshot(q, (snapshot) => { currentShelvesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); filterAndRenderResources(); }, error => console.error("Error in resources subscription:", error)); };

    const getFaviconUrl = (url) => { try { const domain = new URL(url).hostname; return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`; } catch (e) { return 'https://www.google.com/s2/favicons?domain=google.com'; } };

    const filterAndRenderResources = () => {
        const searchTerm = resourcesSearchInput.value.toLowerCase();
        const filteredShelves = currentShelvesData.map(shelf => {
            const items = (shelf.items || []).filter(item => { return (item.type === 'link') && (item.title.toLowerCase().includes(searchTerm) || item.url.toLowerCase().includes(searchTerm)); });
            return { ...shelf, items };
        }).filter(shelf => shelf.items.length > 0 || searchTerm === '');
        renderResources(filteredShelves);
    };

    const renderResources = (shelves) => {
        resourcesGrid.innerHTML = '';
        if (shelves.length === 0) {
            const emptyMessage = resourcesSearchInput.value ? "–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º." : `<div class="col-span-full text-center py-12 text-gray-500"><div class="text-4xl mb-2">üìö</div><p>–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –ø–æ–ª–∏—Ü—å –∑ —Ä–µ—Å—É—Ä—Å–∞–º–∏.</p><p class="text-sm">–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à—É, –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ "–ù–æ–≤–∞ –ü–æ–ª–∏—Ü—è"!</p></div>`;
            resourcesGrid.innerHTML = emptyMessage;
            return;
        }
        shelves.forEach(shelf => {
            const shelfDiv = document.createElement('div');
            shelfDiv.className = 'shelf-card rounded-xl p-4 flex flex-col h-full';
            const itemsHTML = (shelf.items || []).map(item => {
                if(item.type !== 'link') return '';
                const faviconUrl = getFaviconUrl(item.url);
                return `<div class="resource-item flex items-center justify-between p-2 rounded mb-1 group relative cursor-pointer" onclick="window.open('${item.url}', '_blank')"><div class="flex items-center space-x-3 overflow-hidden w-full"><img src="${faviconUrl}" alt="icon" class="resource-favicon flex-shrink-0" onerror="this.src='https://www.google.com/s2/favicons?domain=google.com'"><span class="text-gray-800 font-medium truncate text-sm">${item.title}</span></div><div class="flex space-x-1 absolute right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 rounded shadow-sm backdrop-blur-sm" onclick="event.stopPropagation()"><button class="copy-link-btn text-gray-500 hover:text-indigo-600 p-1.5" data-url="${item.url}" title="–ö–æ–ø—ñ—é–≤–∞—Ç–∏"><i class="fas fa-copy"></i></button><button class="delete-resource-btn text-gray-500 hover:text-red-600 p-1.5" data-shelf-id="${shelf.id}" data-item-id="${item.id}" title="–í–∏–¥–∞–ª–∏—Ç–∏"><i class="fas fa-times"></i></button></div></div>`;
            }).join('');
            shelfDiv.innerHTML = `<div class="flex justify-between items-center mb-4 border-b pb-2 border-blue-200"><h3 class="font-bold text-lg text-gray-800 truncate" title="${shelf.title}">${shelf.title}</h3><button class="delete-shelf-btn text-gray-400 hover:text-red-500 transition-colors" data-id="${shelf.id}"><i class="fas fa-trash-alt"></i></button></div><div class="flex-grow overflow-y-auto max-h-64 mb-4 space-y-1 pr-1 custom-scrollbar">${itemsHTML || '<p class="text-sm text-gray-400 italic text-center mt-4">–ü–æ—Ä–æ–∂–Ω—å–æ</p>'}</div><button class="add-item-btn w-full py-2 rounded-lg border-2 border-dashed border-indigo-300 text-indigo-500 hover:bg-indigo-50 hover:border-indigo-500 transition-all font-medium text-sm" data-id="${shelf.id}">+ –î–æ–¥–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>`;
            shelfDiv.querySelector('.delete-shelf-btn').addEventListener('click', () => showConfirmModal(() => deleteShelf(shelf.id), `–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ª–∏—Ü—é "${shelf.title}" —Ç–∞ –≤—Å—ñ —ó—ó —Ä–µ—Å—É—Ä—Å–∏?`, "–í–∏–¥–∞–ª–∏—Ç–∏"));
            shelfDiv.querySelector('.add-item-btn').addEventListener('click', () => openAddResourceModal(shelf.id));
            shelfDiv.querySelectorAll('.delete-resource-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = e.currentTarget.dataset.itemId;
                    const originalShelf = currentShelvesData.find(s => s.id === shelf.id);
                    if(originalShelf) deleteResource(shelf.id, itemId, originalShelf.items);
                });
            });
            shelfDiv.querySelectorAll('.copy-link-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { navigator.clipboard.writeText(e.currentTarget.dataset.url); showNotification("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É."); });
            });
            resourcesGrid.appendChild(shelfDiv);
        });
    };

    const addShelf = async () => { const title = shelfNameInput.value.trim(); if (!title || !userId) return; try { await addDoc(collection(db, `artifacts/${appId}/users/${userId}/resources`), { title: title, createdAt: serverTimestamp(), items: [] }); addShelfModal.classList.add('hidden'); shelfNameInput.value = ''; } catch (e) { console.error("Error adding shelf: ", e); } };
    const deleteShelf = async (shelfId) => { if (!userId || !shelfId) return; try { await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/resources`, shelfId)); } catch (e) { console.error("Error deleting shelf: ", e); } };
    const openAddResourceModal = (shelfId) => { currentShelfIdForResource = shelfId; resourceTitleInput.value = ''; resourceContentInput.value = ''; addResourceModal.classList.remove('hidden'); };
    const addResource = async () => {
        if (!userId || !currentShelfIdForResource) return;
        const title = resourceTitleInput.value.trim();
        let content = resourceContentInput.value.trim();
        if (!title || !content) { showNotification("–ü–æ–º–∏–ª–∫–∞", "–í—Å—ñ –ø–æ–ª—è –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ"); return; }
        if (!content.startsWith('http')) { content = 'https://' + content; }
        const newItem = { id: Date.now().toString() + Math.random().toString(36).substr(2, 5), title: title, type: 'link', url: content };
        try { const shelfRef = doc(db, `artifacts/${appId}/users/${userId}/resources`, currentShelfIdForResource); await updateDoc(shelfRef, { items: arrayUnion(newItem) }); addResourceModal.classList.add('hidden'); } catch (e) { console.error("Error adding resource: ", e); }
    };
    const deleteResource = async (shelfId, itemId, currentItems) => { if (!userId) return; try { const updatedItems = currentItems.filter(item => item.id !== itemId); const shelfRef = doc(db, `artifacts/${appId}/users/${userId}/resources`, shelfId); await updateDoc(shelfRef, { items: updatedItems }); } catch (e) { console.error("Error deleting resource: ", e); } };

    // --- Boards subscription & rendering ---
    const switchMobileTab = (tab) => {
        currentMobileTab = tab;
        if (tab === 'tasks') {
            mobileTabTasks.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            mobileTabTasks.classList.remove('text-gray-500');
            mobileTabStickers.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            mobileTabStickers.classList.add('text-gray-500');
            boardTasksColumn.classList.remove('hidden');
            boardStickersColumn.classList.add('hidden');
            boardTasksColumn.classList.add('md:flex');
            boardStickersColumn.classList.add('md:block');
        } else {
            mobileTabStickers.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            mobileTabStickers.classList.remove('text-gray-500');
            mobileTabTasks.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            mobileTabTasks.classList.add('text-gray-500');
            boardStickersColumn.classList.remove('hidden');
            boardTasksColumn.classList.add('hidden');
            boardStickersColumn.classList.add('md:block');
            boardTasksColumn.classList.add('md:flex');
        }
    };

    const renderBoardTask = (item) => {
        const total = item.subtasks ? item.subtasks.length : 0;
        const done = item.subtasks ? item.subtasks.filter(s => s.completed).length : 0;
        const percent = total > 0 ? Math.round((done/total) * 100) : 0;

        const el = document.createElement('div');
        el.className = 'board-task-card p-3 mb-2 border rounded';

        let subtasksHtml = '';
        if(item.subtasks) {
            subtasksHtml = item.subtasks.map((s, idx) => `
                <div class="flex items-start gap-2 mt-1">
                    <input type="checkbox" class="mt-1 cursor-pointer" ${s.completed ? 'checked' : ''} data-idx="${idx}">
                    <span class="text-sm ${s.completed ? 'line-through text-gray-400' : 'text-gray-700'}">${s.text}</span>
                </div>
            `).join('');
        }

        el.innerHTML = `
            <div class="flex justify-between items-start mb-1">
                <h4 class="font-bold text-gray-800">${item.text}</h4>
                <div class="flex gap-2">
                    <button class="text-blue-400 hover:text-blue-600 edit-item-btn"><i class="fas fa-edit"></i></button>
                    <button class="text-red-400 hover:text-red-600 delete-item-btn"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                <div class="bg-indigo-600 h-1.5 rounded-full transition-all duration-300" style="width: ${percent}%"></div>
            </div>
            <div class="text-xs text-gray-500 mb-2">${done}/${total} –≤–∏–∫–æ–Ω–∞–Ω–æ</div>
            <div class="pl-1 space-y-1">
                ${subtasksHtml}
            </div>
        `;

        const deleteBtn = el.querySelector('.delete-item-btn');
        if (deleteBtn) deleteBtn.addEventListener('click', () => deleteBoardItem_withLogging(item.id));
        const editBtn = el.querySelector('.edit-item-btn');
        if (editBtn) editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditBoardTask(item); });
        el.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => toggleSubtask_withLogging(item, parseInt(e.target.dataset.idx), e.target.checked));
        });

        boardTasksList.appendChild(el);
    };

    const renderBoardSticker = (item) => {
        const el = document.createElement('div');
        el.className = `sticker ${item.color} p-4 w-full aspect-square flex flex-col relative transform rotate-1`;
        el.innerHTML = `
            <button class="absolute top-1 right-1 text-gray-600 hover:text-red-600 delete-sticker-btn"><i class="fas fa-times"></i></button>
            <div class="flex-grow flex items-center justify-center text-center font-medium text-gray-800 break-words overflow-hidden p-2">
                ${item.text}
            </div>
        `;
        el.querySelector('.delete-sticker-btn').addEventListener('click', () => deleteBoardItem_withLogging(item.id));
        boardStickersArea.appendChild(el);
    };

    // --- Board items subscription ---
    const subscribeToBoardItems = (boardId) => {
        if(unsubscribeFromBoardItems) unsubscribeFromBoardItems();
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'board_items'), where('boardId', '==', boardId));
        unsubscribeFromBoardItems = onSnapshot(q, (snapshot) => {
            boardTasksList.innerHTML = '';
            boardStickersArea.innerHTML = '';
            snapshot.forEach(d => {
                const item = { id: d.id, ...d.data() };
                if(item.type === 'task') renderBoardTask(item);
                else if(item.type === 'sticker') renderBoardSticker(item);
            });
        }, error => console.error("Board items subscription error:", error));
    };

    // --- Logging activities to board_activities (new collection) ---
    const logBoardActivity = async (boardId, payload) => {
        try {
            if (!boardId || !userId) return;
            const data = { boardId, ...payload, performedBy: userId, timestamp: serverTimestamp() };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'board_activities'), data);
        } catch (e) { console.error("Error logging board activity:", e); }
    };

    // --- Report modal subscription & rendering ---
    const boardReportModal = getEl('board-report-modal');
    const boardReportBody = getEl('board-report-body');
    const boardReportTitle = getEl('board-report-title');
    const boardReportSubtitle = getEl('board-report-subtitle');
    const boardReportClose = getEl('board-report-close');
    const boardReportFilterUser = getEl('board-report-filter-user');
    const boardReportFilterType = getEl('board-report-filter-type');
    const boardReportSearch = getEl('board-report-search');
    const boardReportDownload = getEl('board-report-download');

    let unsubscribeFromBoardActivities = null;
    let latestBoardActivities = [];

    const formatActivityText = (act) => {
        const actor = getDisplayNameFor(act.performedBy);
        switch(act.type) {
            case 'task_added': return `${actor} —Å—Ç–≤–æ—Ä–∏–≤ –∑–∞–≤–¥–∞–Ω–Ω—è: ¬´${act.text || act.itemText || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}¬ª`;
            case 'subtask_checked': return `${actor} –≤–∏–∫—Ä–µ—Å–ª–∏–≤ –ø—É–Ω–∫—Ç: ¬´${act.subtaskText || '‚Ä¶'}¬ª`;
            case 'subtask_unchecked': return `${actor} –≤—ñ–¥–Ω–æ–≤–∏–≤ –ø—É–Ω–∫—Ç: ¬´${act.subtaskText || '‚Ä¶'}¬ª`;
            case 'sticker_added': return `${actor} –¥–æ–¥–∞–≤ —Å—Ç—ñ–∫–µ—Ä: ¬´${act.stickerText || '‚Ä¶'}¬ª`;
            case 'sticker_removed': return `${actor} –≤–∏–¥–∞–ª–∏–≤ —Å—Ç—ñ–∫–µ—Ä: ¬´${act.stickerText || '‚Ä¶'}¬ª`;
            case 'task_deleted': return `${actor} –≤–∏–¥–∞–ª–∏–≤ –µ–ª–µ–º–µ–Ω—Ç`;
            default: return `${actor} –∑—Ä–æ–±–∏–≤ –¥—ñ—é: ${act.type}`;
        }
    };

    const subscribeToBoardActivities = (boardId) => {
        if (unsubscribeFromBoardActivities) unsubscribeFromBoardActivities();
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'board_activities'), where('boardId', '==', boardId));
        unsubscribeFromBoardActivities = onSnapshot(q, (snapshot) => {
            latestBoardActivities = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.toMillis?.() || 0) - (a.timestamp?.toMillis?.() || 0));
            renderBoardReport(latestBoardActivities);
            populateFilterUsers(latestBoardActivities);
        }, error => console.error("Board activities subscription error:", error));
    };

    const populateFilterUsers = (activities) => {
        const ids = new Set();
        activities.forEach(a => ids.add(a.performedBy));
        boardReportFilterUser.innerHTML = '<option value="">–£—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</option>';
        Array.from(ids).forEach(id => {
            const name = getDisplayNameFor(id);
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = name;
            boardReportFilterUser.appendChild(opt);
        });
    };

    const renderBoardReport = (activities) => {
        const filterUser = boardReportFilterUser.value;
        const filterType = boardReportFilterType.value;
        const search = boardReportSearch.value.trim().toLowerCase();
        let filtered = activities.slice();
        if (filterUser) filtered = filtered.filter(a => a.performedBy === filterUser);
        if (filterType) filtered = filtered.filter(a => a.type === filterType);
        if (search) filtered = filtered.filter(a => {
            const text = (a.text || a.itemText || a.subtaskText || a.stickerText || '').toString().toLowerCase();
            return text.includes(search) || getDisplayNameFor(a.performedBy).toLowerCase().includes(search) || a.type.includes(search);
        });

        const emptyEl = getEl('board-report-empty'); // –ê–±–æ document.getElementById

        if (emptyEl) { // <--- –î–û–î–ê–ô–¢–ï –¶–Æ –ü–ï–†–ï–í–Ü–†–ö–£
            if (!filtered || filtered.length === 0) {
                boardReportBody.appendChild(emptyEl);
                emptyEl.style.display = 'block';
                return;
            }
            emptyEl.style.display = 'none';
        } else {
            // –Ø–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≤–∏—Ö–æ–¥–∏–º–æ –∞–±–æ –ª–æ–≥—É—î–º–æ –ø–æ–º–∏–ª–∫—É
            console.error("–ï–ª–µ–º–µ–Ω—Ç 'board-report-empty' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!");
        }

        const grouped = {};
        filtered.forEach(a => {
            const d = a.timestamp?.toDate ? a.timestamp.toDate() : (a.timestamp ? new Date(a.timestamp) : new Date());
            const key = d.toISOString().slice(0,10);
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(a);
        });

        Object.keys(grouped).sort((a,b) => b.localeCompare(a)).forEach(dayKey => { 
    const dayHeader = document.createElement('div');
    // –ù–µ–∑–Ω–∞—á–Ω–∞ –∑–º—ñ–Ω–∞ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–∞ –ª—ñ–Ω—ñ—ó —á–∞—Å—É
    dayHeader.className = 'py-2 text-sm font-semibold text-gray-600 flex justify-center'; 
    const day = new Date(dayKey);
    const dayString = day.toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' });
    dayHeader.innerHTML = `<h3 class="text-center text-lg mt-4 mb-4 relative z-10 bg-white inline-block px-4 rounded-full border border-gray-200 shadow-sm">${dayString}</h3>`;
    boardReportBody.appendChild(dayHeader);
    
    grouped[dayKey].forEach(a => {
            try { // <--- –î–û–î–ê–ù–û TRY/CATCH –î–õ–Ø –Ü–ó–û–õ–Ø–¶–Ü–á –ü–û–ú–ò–õ–û–ö
                const performerName = getDisplayNameFor(a.performedBy);
                // –ë–ï–ó–ü–ï–ß–ù–ï –û–¢–†–ò–ú–ê–ù–ù–Ø –Ü–ù–Ü–¶–Ü–ê–õ–Ü–í:
                const performerInitials = (performerName && performerName.length > 0) ? performerName.charAt(0).toUpperCase() : '?'; 
                let icon = 'fas fa-info-circle';
                let color = 'bg-gray-400';
                let actionText = '–≤–∏–∫–æ–Ω–∞–≤(–ª–∞) –Ω–µ–≤—ñ–¥–æ–º—É –¥—ñ—é';
                
                // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏, –∫–æ–ª—å–æ—Ä—É —Ç–∞ —Ç–µ–∫—Å—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∏–ø—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (a.type)
                switch (a.type) {
                    case 'task_added':
                        icon = 'fas fa-plus-circle'; color = 'bg-green-500'; 
                        // –ë–ï–ó–ü–ï–ß–ù–ò–ô –î–û–°–¢–£–ü: a.itemText || ''
                        actionText = `–¥–æ–¥–∞–≤(–ª–∞) –∑–∞–≤–¥–∞–Ω–Ω—è: "${a.itemText || ''}"`;
                        break;
                    case 'task_completed':
                        icon = 'fas fa-check-circle'; color = 'bg-indigo-500'; 
                        actionText = `–∑–∞–≤–µ—Ä—à–∏–≤(–ª–∞) –∑–∞–≤–¥–∞–Ω–Ω—è: "${a.itemText || ''}"`;
                        break;
                    case 'task_subtask_toggled':
                        icon = 'fas fa-clipboard-check'; color = 'bg-blue-500'; 
                        actionText = `–≤—ñ–¥–º—ñ—Ç–∏–≤(–ª–∞) –∫—Ä–æ–∫ "${a.subtaskText || ''}" —è–∫ ${a.completed ? '–≤–∏–∫–æ–Ω–∞–Ω–∏–π' : '–Ω–µ–≤–∏–∫–æ–Ω–∞–Ω–∏–π'} —É –∑–∞–≤–¥–∞–Ω–Ω—ñ: "${a.itemText || ''}"`;
                        break;
                    case 'sticker_added':
                        icon = 'fas fa-thumbtack'; color = 'bg-yellow-500'; 
                        // –ë–ï–ó–ü–ï–ß–ù–ò–ô –î–û–°–¢–£–ü: a.stickerText || ''
                        actionText = `–ø—Ä–∏–ª—ñ–ø–∏–≤(–ª–∞) —Å—Ç—ñ–∫–µ—Ä: "${a.stickerText || ''}"`;
                        break;
                    case 'board_member_added':
                        icon = 'fas fa-user-plus'; color = 'bg-purple-500'; 
                        actionText = `–¥–æ–¥–∞–≤(–ª–∞) —É—á–∞—Å–Ω–∏–∫–∞ ${getDisplayNameFor(a.newMemberId || '')}`;
                        break;
                    case 'task_deleted':
                        icon = 'fas fa-trash-alt'; color = 'bg-red-600';
                        actionText = `–≤–∏–¥–∞–ª–∏–≤(–ª–∞) –∑–∞–≤–¥–∞–Ω–Ω—è: "${a.itemText || ''}"`;
                        break;
                    default:
                        actionText = `–≤–∏–∫–æ–Ω–∞–≤(–ª–∞) –Ω–µ–≤—ñ–¥–æ–º—É –¥—ñ—é (${a.type || 'UNKNOWN TYPE'})`;
                }
                
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è HTML-—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –µ–ª–µ–º–µ–Ω—Ç–∞ —á–∞—Å–æ–≤–æ—ó —à–∫–∞–ª–∏
                const html = `
                    <div class="timeline-avatar ${color}">${performerInitials}</div>
                    <div class="timeline-card">
                        <div class="font-semibold text-gray-800">${performerName}</div>
                        <p class="text-sm text-gray-700 mt-1 break-words">${actionText}</p>
                        <div class="timeline-meta">
                            <span class="timeline-badge"><i class="${icon} text-xs mr-1"></i>${(a.type || 'error').replace(/_/g, ' ')}</span>
                            <span class="ml-2">${formatTime(a.timestamp)}</span>
                        </div>
                    </div>
                `;

                const el = document.createElement('div');
                el.className = 'timeline-item bg-white shadow-md border border-gray-100 mb-3 relative z-10';
                el.innerHTML = html;
                
                // –¶–µ –º–∞—î –±—É—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä—è–¥–æ–∫ —É —Ü–∏–∫–ª—ñ:
                boardReportBody.appendChild(el); 

            } catch (e) {
                // –Ø–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –≤–∏–Ω–∏–∫–∞—î, –º–∏ —ó—ó –ª–æ–≥—É—î–º–æ —ñ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ —Ü–∏–∫–ª
                console.error("–ü–æ–º–∏–ª–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –µ–ª–µ–º–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ:", a, e);
            }
        });
});
    };

    const openBoardReport = () => {
        if (!currentBoardId) { showNotification('–ü–æ–º–∏–ª–∫–∞', '–î–æ—à–∫–∞ –Ω–µ –≤–∏–±—Ä–∞–Ω–∞'); return; }
        boardReportTitle.textContent = `–ó–≤—ñ—Ç ‚Äî ${activeBoardTitle.textContent || '–î–æ—à–∫–∞'}`;
        boardReportSubtitle.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ–¥—ñ—ó –¥–ª—è –¥–æ—à–∫–∏`;
        boardReportModal.classList.remove('hidden');
        subscribeToBoardActivities(currentBoardId);
    };

    boardReportClose.addEventListener('click', () => {
        boardReportModal.classList.add('hidden');
        if (unsubscribeFromBoardActivities) { unsubscribeFromBoardActivities(); unsubscribeFromBoardActivities = null; }
    });

    boardReportFilterUser.addEventListener('change', () => renderBoardReport(latestBoardActivities));
    boardReportFilterType.addEventListener('change', () => renderBoardReport(latestBoardActivities));
    boardReportSearch.addEventListener('input', debounce(() => renderBoardReport(latestBoardActivities), 250));

    boardReportDownload.addEventListener('click', () => {
        const data = latestBoardActivities;
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `board-${currentBoardId || 'report'}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    });

    // --- replace original functions with logging counterparts ---
    // addBoardTask_withLogging
    const addBoardTask_withLogging = async () => {
        const title = boardTaskTitle.value.trim();
        if(!title || !currentBoardId) return;

        const subtaskInputs = document.querySelectorAll('.subtask-input');
        const subtasks = Array.from(subtaskInputs).map(inp => ({
            text: inp.value.trim(),
            completed: false
        })).filter(s => s.text !== '');

        try {
            const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'board_items'), {
                boardId: currentBoardId,
                type: 'task',
                text: title,
                subtasks,
                createdAt: serverTimestamp()
            });
            // log activity
            await logBoardActivity(currentBoardId, {
                type: 'task_added',
                itemId: docRef.id,
                itemText: title
            });
            addBoardTaskModal.classList.add('hidden');
            boardTaskTitle.value = '';
            subtasksContainer.innerHTML = '<input type="text" placeholder="–ö—Ä–æ–∫ 1" class="subtask-input w-full px-3 py-1.5 rounded border border-gray-200 text-sm">';
        } catch(e) { console.error("Error adding board task", e); }
    };

    // toggleSubtask_withLogging
    const toggleSubtask_withLogging = async (item, idx, isChecked) => {
        try {
            if (!item || !Array.isArray(item.subtasks)) return;
            const newSubtasks = JSON.parse(JSON.stringify(item.subtasks));
            const oldText = newSubtasks[idx]?.text || '';
            newSubtasks[idx].completed = isChecked;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'board_items', item.id), {
                subtasks: newSubtasks
            });
            await logBoardActivity(item.boardId || currentBoardId, {
                type: isChecked ? 'subtask_checked' : 'subtask_unchecked',
                itemId: item.id,
                subtaskIdx: idx,
                subtaskText: oldText
            });
        } catch (e) { console.error("Error toggling subtask:", e); }
    };

    // addSticker_withLogging
    const addSticker_withLogging = async () => {
        try {
            const text = stickerTextInput.value.trim();
            if(!text || !currentBoardId) return;
            const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'board_items'), {
                boardId: currentBoardId,
                type: 'sticker',
                text,
                color: selectedStickerColor,
                createdAt: serverTimestamp()
            });
            await logBoardActivity(currentBoardId, {
                type: 'sticker_added',
                itemId: docRef.id,
                stickerText: text,
                stickerColor: selectedStickerColor
            });
            addStickerModal.classList.add('hidden');
            stickerTextInput.value = '';
        } catch(e) { console.error("Error adding sticker", e); }
    };

    // deleteBoardItem_withLogging
    const deleteBoardItem_withLogging = async (itemId) => {
        try {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç?')) return;
            const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'board_items', itemId);
            const snapshot = await getDoc(itemRef);
            if (!snapshot.exists()) { console.warn('Item not found for deletion', itemId); return; }
            const item = { id: snapshot.id, ...snapshot.data() };
            if(item.type === 'sticker') {
                await logBoardActivity(item.boardId || currentBoardId, {
                    type: 'sticker_removed',
                    itemId: item.id,
                    stickerText: item.text,
                    stickerColor: item.color
                });
            } else {
                await logBoardActivity(item.boardId || currentBoardId, {
                    type: 'task_deleted',
                    itemId: item.id,
                    itemText: item.text
                });
            }
            await deleteDoc(itemRef);
        } catch (e) {
            console.error("Error deleting board item with logging:", e);
        }
    };

    // --- Board subscription & UI wiring ---
    const subscribeToBoards = () => {
        if(!userId) return;
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'boards'), where('members', 'array-contains', userId));
        unsubscribeFromBoards = onSnapshot(q, (snapshot) => {
            boardsGrid.innerHTML = '';
            if(snapshot.empty) {
                boardsGrid.innerHTML = `<p class="text-center col-span-3 text-gray-500">–í–∏ —â–µ –Ω–µ –º–∞—î—Ç–µ —Å–ø—ñ–ª—å–Ω–∏—Ö –¥–æ—à–æ–∫.</p>`;
                return;
            }
            snapshot.forEach(docSnap => {
                const board = { id: docSnap.id, ...docSnap.data() };
                const isOwner = board.ownerId === userId;

                const el = document.createElement('div');
                el.className = 'bg-white p-6 rounded-xl shadow-lg border border-orange-100 cursor-pointer hover:shadow-xl transition-all transform hover:-translate-y-1 relative group';

                const deleteBtnHtml = isOwner 
                    ? `<button class="delete-board-btn absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity" data-id="${board.id}" title="–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—à–∫—É"><i class="fas fa-trash-alt"></i></button>`
                    : '';

                const editBtnHtml = isOwner
                    ? `<button class="edit-board-btn absolute top-2 left-2 text-gray-300 hover:text-blue-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity" data-id="${board.id}" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É"><i class="fas fa-edit"></i></button>`
                    : '';

                el.innerHTML = `
                    <h3 class="font-bold text-xl text-gray-800 mb-2 pr-6">${board.title}</h3>
                    <p class="text-sm text-gray-500"><i class="fas fa-user-friends"></i> ${board.members ? board.members.length : 0} —É—á–∞—Å–Ω–∏–∫—ñ–≤</p>
                    ${deleteBtnHtml}
                    ${editBtnHtml}
                `;

                el.addEventListener('click', (e) => {
                    if(e.target.closest('.delete-board-btn') || e.target.closest('.edit-board-btn')) return;
                    openActiveBoard(board);
                });

                if(isOwner && el.querySelector('.delete-board-btn')) {
                    el.querySelector('.delete-board-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showConfirmModal(() => deleteBoard(board.id), `–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—à–∫—É "${board.title}"? –¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ —Å—Ç—ñ–∫–µ—Ä–∏ –Ω–∞ –Ω—ñ–π.`, "–í–∏–¥–∞–ª–∏—Ç–∏");
                    });
                }

                if(isOwner && el.querySelector('.edit-board-btn')) {
                    el.querySelector('.edit-board-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditBoardModal(board);
                    });
                }

                boardsGrid.appendChild(el);
            });
        });
    };

    const createBoard = async () => {
        const title = boardNameInput.value.trim();
        if(!title || !userId) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'boards'), {
                title,
                ownerId: userId,
                members: [userId],
                createdAt: serverTimestamp()
            });
            createBoardModal.classList.add('hidden');
            boardNameInput.value = '';
        } catch(e) { console.error("Error creating board", e); }
    };

    const deleteBoard = async (boardId) => {
        if(!boardId || !userId) return;
        try {
            const itemsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'board_items'), where('boardId', '==', boardId));
            const itemsSnapshot = await getDocs(itemsQuery);
            const batch = writeBatch(db);
            itemsSnapshot.forEach(d => batch.delete(d.ref));
            batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'boards', boardId));
            await batch.commit();
            showNotification('–£—Å–ø—ñ—Ö', '–î–æ—à–∫—É —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ.');
        } catch(e) {
            console.error("Error deleting board:", e);
            showNotification('–ü–æ–º–∏–ª–∫–∞', '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—à–∫—É.');
        }
    };

    const openActiveBoard = (board) => {
        currentBoardId = board.id;
        activeBoardTitle.textContent = board.title;
        getEl('board-member-count').textContent = board.members.length;
        boardsListView.classList.add('hidden');
        activeBoardView.classList.remove('hidden');
        activeBoardView.classList.add('flex');
        switchMobileTab('tasks');
        boardFriendSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –¥—Ä—É–≥–∞</option>';
        Object.values(friendsCache).forEach(f => {
            if(!board.members.includes(f.userId)) {
                boardFriendSelect.innerHTML += `<option value="${f.userId}">${f.name}</option>`;
            }
        });
        subscribeToBoardItems(board.id);

        // also ensure "–ó–≤—ñ—Ç" button exists in header
        (function addBoardReportButton() {
            try {
                const header = document.querySelector('#active-board-title')?.parentElement;
                if (!header) return;
                if (getEl('open-board-report-btn')) return;
                const btn = document.createElement('button');
                btn.id = 'open-board-report-btn';
                btn.className = 'px-3 py-1 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-sm';
                btn.textContent = '–ó–≤—ñ—Ç';
                btn.addEventListener('click', openBoardReport);
                header.appendChild(btn);
            } catch (e) { console.error(e); }
        })();

        // subscribe to board activities briefly so user sees recent actions quickly
        subscribeToBoardActivities(board.id);
    };

    // --- Board items creation (wire to UI events) ---
    // If original named functions exist in global scope, this script substitutes them,
    // but we also wire event listeners below to our implementations.

    // addSticker and addBoardTask and others are used by UI buttons -> ensure they use our logging variants
    // Wiring event listeners:
    saveBoardTaskBtn.addEventListener('click', addBoardTask_withLogging);
    saveStickerBtn.addEventListener('click', addSticker_withLogging);

    // addBoardMember
    const addBoardMember = async () => {
        const friendId = boardFriendSelect.value;
        if(!friendId || !currentBoardId) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'boards', currentBoardId), { members: arrayUnion(friendId) });
            addBoardMemberModal.classList.add('hidden');
            const currentCount = parseInt(getEl('board-member-count').textContent);
            getEl('board-member-count').textContent = currentCount + 1;
        } catch(e) { console.error("Error adding member", e); }
    };

    // --- Event Listeners (existing ones + our additions) ---
    googleSignInButton.addEventListener('click', signInWithGoogle);
    signOutButton.addEventListener('click', signOutUser);
    addTaskButton.addEventListener('click', addTask);
    confirmDeleteButton.addEventListener('click', () => { if (currentAction) currentAction(); hideConfirmModal(); });
    cancelDeleteButton.addEventListener('click', hideConfirmModal);
    closeNotificationBtn.addEventListener('click', hideNotification);
    saveEditBtn.addEventListener('click', saveEditedTask);
    cancelEditBtn.addEventListener('click', hideViewEditModal);
    saveSettingsBtn.addEventListener('click', saveSettings);
    const toggleSection = (listEl, btnEl) => { listEl.classList.toggle('hidden'); btnEl.textContent = listEl.classList.contains('hidden') ? '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏' : '–ó–≥–æ—Ä–Ω—É—Ç–∏'; saveExpansionState(); };
    deferredToggleBtn.addEventListener('click', () => toggleSection(deferredTasksList, deferredToggleBtn));
    completedToggleBtn.addEventListener('click', () => toggleSection(completedTasksList, completedToggleBtn));
    settingsToggleBtn.addEventListener('click', () => toggleSection(settingsContent, settingsToggleBtn));
    friendsToggleBtn.addEventListener('click', () => toggleSection(friendsContent, friendsToggleBtn));
    addFriendOpenBtn.addEventListener('click', showAddFriendModal);
    cancelFriendBtn.addEventListener('click', hideAddFriendModal);
    saveFriendBtn.addEventListener('click', saveFriend);
    assignTaskOpenBtn.addEventListener('click', showAssignTaskModal);
    cancelAssignBtn.addEventListener('click', hideAssignTaskModal);
    sendTaskBtn.addEventListener('click', sendAssignedTask);
    chatsBtn.addEventListener('click', openChatView);
    backToTasksBtn.addEventListener('click', closeChatView);
    enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
    closeImageViewerBtn.addEventListener('click', () => imageViewerModal.classList.add('hidden'));
    attachFileBtn.addEventListener('click', () => imageUploadInput.click());
    imageUploadInput.addEventListener('change', (e) => { if (e.target.files[0]) uploadImageAndSendMessage(e.target.files[0]); });

    reportBtn.addEventListener('click', openReportView);
    backToTasksFromReportBtn.addEventListener('click', closeReportView);
    reportTableBody.addEventListener('click', (e) => {
        const card = e.target.closest('.report-task-card');
        if (card && card.dataset.taskText) {
            showTaskDetailsModal(card.dataset.taskText, card.dataset.taskId);
        }
    });
    closeTaskDetailsBtn.addEventListener('click', hideTaskDetailsModal);
    deleteFromReportBtn.addEventListener('click', () => {
        showConfirmModal(
            () => deleteSharedTaskFromReport(),
            "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –Ω–∞–∑–∞–≤–∂–¥–∏ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è –∑—ñ –∑–≤—ñ—Ç—É? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.",
            "–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏"
        );
    });

    incomingTaskAcceptBtn.addEventListener('click', () => {
        if (currentIncomingTask) {
            acceptIncomingTask(currentIncomingTask);
            hideViewIncomingTaskModal();
        }
    });

    incomingTaskDeclineBtn.addEventListener('click', () => {
        if (currentIncomingTask) {
            updateSharedTaskStatus(currentIncomingTask.id, 'declined');
            hideViewIncomingTaskModal();
        }
    });

    incomingTaskCloseBtn.addEventListener('click', hideViewIncomingTaskModal);

    cancelActionsBtn.addEventListener('click', hideTaskActionsModal);

    actionDeferBtn.addEventListener('click', () => {
        if (currentTaskForAction) {
            updateTaskStatus(currentTaskForAction.id, 'deferred', currentTaskForAction.originalSharedTaskId);
            hideTaskActionsModal();
        }
    });

    actionActivateBtn.addEventListener('click', () => {
        if(currentTaskForAction) {
            updateTaskStatus(currentTaskForAction.id, 'active', currentTaskForAction.originalSharedTaskId);
            hideTaskActionsModal();
        }
    });

    actionProlongBtn.addEventListener('click', () => {
        if (currentTaskForAction) {
            prolongTask(currentTaskForAction.id);
            hideTaskActionsModal();
        }
    });

    actionDeleteBtn.addEventListener('click', () => {
        if (currentTaskForAction) {
            const taskToDelete = currentTaskForAction;
            hideTaskActionsModal();
            showConfirmModal(() => deleteTask(taskToDelete), "–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è?", "–í–∏–¥–∞–ª–∏—Ç–∏");
        }
    });

    // Resource Event Listeners
    resourcesBtn.addEventListener('click', openResourcesView);
    backToTasksFromResourcesBtn.addEventListener('click', closeResourcesView);
    addShelfBtn.addEventListener('click', () => { shelfNameInput.value = ''; addShelfModal.classList.remove('hidden'); });
    cancelShelfBtn.addEventListener('click', () => addShelfModal.classList.add('hidden'));
    saveShelfBtn.addEventListener('click', addShelf);
    cancelResourceBtn.addEventListener('click', () => addResourceModal.classList.add('hidden'));
    saveResourceBtn.addEventListener('click', addResource);
    resourcesSearchInput.addEventListener('input', filterAndRenderResources);

    const handleSendMessage = () => { if (!selectedFriendForChat) { showNotification('–ü–æ–º–∏–ª–∫–∞', '–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –¥—Ä—É–≥–∞ –∑—ñ —Å–ø–∏—Å–∫—É.'); return; } sendChatMessage({ text: chatMessageInput.value, recipient: selectedFriendForChat }); };
    sendChatMessageBtn.addEventListener('click', handleSendMessage);
    chatMessageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });

    // Boards listeners
    boardsBtn.addEventListener('click', () => { mainContent.classList.add('hidden'); boardsSection.classList.remove('hidden'); subscribeToBoards(); });
    backToTasksFromBoardsBtn.addEventListener('click', () => { boardsSection.classList.add('hidden'); mainContent.classList.remove('hidden'); if(unsubscribeFromBoards) unsubscribeFromBoards(); });
    createBoardBtn.addEventListener('click', () => { boardNameInput.value = ''; createBoardModal.classList.remove('hidden'); });
    cancelBoardBtn.addEventListener('click', () => createBoardModal.classList.add('hidden'));
    saveBoardBtn.addEventListener('click', createBoard);
    backToBoardsListBtn.addEventListener('click', () => { activeBoardView.classList.add('hidden'); activeBoardView.classList.remove('flex'); boardsListView.classList.remove('hidden'); if(unsubscribeFromBoardItems) unsubscribeFromBoardItems(); });

    addBoardMemberBtn.addEventListener('click', () => addBoardMemberModal.classList.remove('hidden'));
    cancelBoardMemberBtn.addEventListener('click', () => addBoardMemberModal.classList.add('hidden'));
    saveBoardMemberBtn.addEventListener('click', addBoardMember);

    addBoardTaskBtn.addEventListener('click', () => {
        boardTaskTitle.value = '';
        subtasksContainer.innerHTML = '<input type="text" placeholder="–ö—Ä–æ–∫ 1" class="subtask-input w-full px-3 py-1.5 rounded border border-gray-200 text-sm">';
        addBoardTaskModal.classList.remove('hidden');
    });
    cancelBoardTaskBtn.addEventListener('click', () => addBoardTaskModal.classList.add('hidden'));
    addSubtaskFieldBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `–ö—Ä–æ–∫ ${subtasksContainer.children.length + 1}`;
        input.className = 'subtask-input w-full px-3 py-1.5 rounded border border-gray-200 text-sm';
        subtasksContainer.appendChild(input);
    });

    addStickerBtn.addEventListener('click', () => { stickerTextInput.value = ''; addStickerModal.classList.remove('hidden'); });
    cancelStickerBtn.addEventListener('click', () => addStickerModal.classList.add('hidden'));

    mobileTabTasks.addEventListener('click', () => switchMobileTab('tasks'));
    mobileTabStickers.addEventListener('click', () => switchMobileTab('stickers'));

    document.querySelectorAll('.color-option').forEach(el => {
        el.addEventListener('click', (e) => {
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('border-gray-600'));
            e.target.classList.add('border-gray-600');
            selectedStickerColor = e.target.dataset.color;
        });
    });

    // wire addBoardTask/saveSticker event names to our functions (some elements already wired above)
    saveBoardTaskBtn.addEventListener('click', addBoardTask_withLogging);
    saveStickerBtn.addEventListener('click', addSticker_withLogging);

    // --- Auth state ---
    onAuthStateChanged(auth, async (user) => {
        loadingSpinner.classList.add('hidden');
        if (user) {
            userId = user.uid;
            userIdSpan.textContent = userId;
            authButtons.classList.add('hidden');
            contentSection.classList.remove('hidden');
            await loadSettings();
            subscribeToFriends();
            subscribeToTasks();
            subscribeToIncomingTasks();
            subscribeToUnreadCounts();
            checkNotificationStatus();
        } else {
            userId = null;
            userIdSpan.textContent = '–ù–µ–º–∞—î';
            authButtons.classList.remove('hidden');
            contentSection.classList.add('hidden');
            chatSection.classList.add('hidden');
            reportSection.classList.add('hidden');
            resourcesSection.classList.add('hidden');
            boardsSection.classList.add('hidden');
        }
    });

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    if (initialAuthToken) { signInWithCustomToken(auth, initialAuthToken).catch(() => signInAnonymously(auth)); } else { signInAnonymously(auth); }
};
</script>
</body>
</html>